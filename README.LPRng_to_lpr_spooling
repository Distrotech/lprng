		LPRng to LPR Spooling
		  Patrick Powell
		Wed Jan 22 11:29:26 PST 1997

One of the problems you may encounter is using LPRng with older
(i.e. - vintage) lpr implementations, or with network connected printers
that have a built in LPR server.

My best advice on connecting to network printers is not to use the LPR
interface,  but to connect to the printer directly.  Usually there is
a reserved port available that  provides a direct network connection.
For the HP JetDirect and other HP products,  this is usually 9100.
Combine this operation with the CTI-hpif filters and you will usually
not have any problems.  The printcap resembles:

printer
	:lp=networkname%9100
	:sd=/whatever
	:if=/usr/local/lib/filters/ifhp
	:of=/usr/local/lib/filters/ofhp

RFC1179 defines the protocol that should be used to transfer files
between two LPD servers.  The basic rules are as follows,
together with the headaches that these cause.

1. Servers originate a connection from ports in the range 721-731.

   WHY:  these are the 'reserved' ports in UNIX, and normal users
   cannot open connections from them.  This provides a small amount
   of sercurity.

   IMPLICATION:  in order to do use a reserved port,  the program
   must have root privileges.  This means the LPR, LPD, LPQ, etc.,
   programs must be installed SUID root.  This can open up a can
   of worms with regard to security,  but LPRng has been designed to
   take as much paranoid care as possible to avoid problems.

   WHAT TO DO:
     In the src/Makefile,  you will need to use
         PERMS=SUID_ROOT_PERMS
     target as shown below.  This will install the executables
	 SUID, and owned by root.

###########################################################################
# 
NORM_PERMS=      0755
SUID_ROOT_PERMS= 04755 -oroot
PERMS=NORM_PERMS
#PERMS=SUID_ROOT_PERMS
###########################################################################

install: all ${INSTALL_LIB} ${INSTALL_BIN} ${INSTALL_MAINT}
	${INSTALLCMD} -m $(PERMS) lpd ${INSTALL_LIB}
	${INSTALLCMD} -m $(PERMS) lpq ${INSTALL_BIN}
	${INSTALLCMD} -m $(PERMS) lprm ${INSTALL_BIN}
	${INSTALLCMD} -m $(PERMS) lpr ${INSTALL_BIN}
	${INSTALLCMD} -m $(PERMS) lpc ${INSTALL_MAINT}
	${INSTALLCMD} -m $(NORM_PERMS) lpf ${INSTALL_LIB}
	${INSTALLCMD} -m $(NORM_PERMS) lpbanner ${INSTALL_LIB}
	${INSTALLCMD} -m $(NORM_PERMS) checkpc ${INSTALL_MAINT}
	${INSTALLCMD} -m $(NORM_PERMS) lpraccnt ${INSTALL_MAINT}
	${INSTALLCMD} -m $(NORM_PERMS) readfilecount ${INSTALL_LIB}
	${INSTALLCMD} -m $(NORM_PERMS) removeoneline ${INSTALL_LIB}
	${INSTALLCMD} -m $(NORM_PERMS) authenticate_pgp ${INSTALL_LIB}
	${INSTALLCMD} -m $(NORM_PERMS) setupauth ${INSTALL_LIB}
	rm -f ${INSTALL_BIN}/lp;     ln -s lpr  ${INSTALL_BIN}/lp;
	rm -f ${INSTALL_BIN}/lpstat; ln -s lpq  ${INSTALL_BIN}/lpstat;
	rm -f ${INSTALL_BIN}/cancel; ln -s lprm ${INSTALL_BIN}/cancel;


2. There are only 10 ports that you can originate a connection from.

   PROBLEM:  once a connection is originated from a port, say 721
   to another host,  the TCP/IP protocol requires that the port
   remain unused,  at least when connecting to the same system.
   This can result in very strange behaviour when sending a large
   number of jobs to a system in short (i.e.- less than 10 minute)
   period.  You may get 'connection refused' messages.

   POSSIBLE SOLUTION:
   It appears that most implementations do not check for the exact
   range 721-731,  but only that the connection originates from a
   reserved port.  You can extend the range of ports by changing the
      originate_port=721 731
   value in the defaults (src/common/defaults.c) file or in the lpd.conf
   file.  I recommend the following:
      originate_port=512 1022

3. Order of file transfer

   An LPD job consists of a control file,  which contains information
   about the job,  and one or more data files.  RFC1179 is silent on the
   order that jobs are sent;  however some implementations REQUIRE that
   the data files be sent first,  followed by the control file.

   SOLUTION:
   Set the 'send_data_first' flag in the printcap for the particular
   printer,  or in the lpd.conf configuration file.  This is:
     :send_data_first:  (printcap)
     send_data_first    (lpd.conf)

   Note that some printers/servers INSIST on the control file first;
   it is not recommended that you set it in the lpd.conf file.
   You can clear the flag using :send_job_first@: if you need to.

4. Control File Contents

	RFC1179 describes a set of fields that MAY appear in the control file.
	It is silent if other ones can appear as well.
	Unfortunately,  some implementations will reject jobs unless they contain
	ONLY fields from a very small set.  In addition,  RFC1179 is silent
	about the ORDER the fields can appear.

	To force LPRng to send jobs with only the restricted set and in the
	most common (i.e. -vintage BSD LPD) implementation,  you can use the
	:bk: (backwards compatible) flag in the printcap for the printer.
	You could also set the flag in the lpd.conf configuration file,
	but this would disable all LPRng extensions.
