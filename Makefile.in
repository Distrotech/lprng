###########################################################################
# LPRng - An Extended Print Spooler System
#
# Copyright 1988-1995 Patrick Powell, San Diego, CA
#     papowell@lprng.com
# See LICENSE for conditions of use.
#
###########################################################################
# MODULE: Makefile.in
# PURPOSE: top level Makefile for LPD Software
# Makefile.in,v 3.23 1998/03/29 19:39:21 papowell Exp
########################################################################## 

#**************###########**************
# You must use ANSI C and GNU Make!
#***************************************

PACKAGE=@PACKAGE@
VERSION=3.7.3
SRC=@srcdir@
@SET_MAKE@
INSTALL=@INSTALL@

# prefix
prefix=@prefix@
# exec prefix
exec_prefix=@exec_prefix@
# for binaries
bindir=@bindir@
# for admin type of binaries
sbindir=@sbindir@
# for the filters
libexecdir=@libexecdir@
# for the configuration stuff
sysconfdir=@sysconfdir@
# for the man pages
mandir=@mandir@

LPD_PERMS_PATH=\"@LPD_PERMS_PATH@\"
LPD_CONF_PATH=\"@LPD_CONF_PATH@\"
PRINTCAP_PATH=\"@PRINTCAP_PATH@\"
LPD_PATH=\"@LPD_DIR@/lpd\"
SHELL="@SHELL@"
LOCKFILE=\"@LOCKFILE@\"
PSHOWALL="@PSHOWALL@"
FILTER_DIR=@FILTER_DIR@
LOCALEDIR=@LOCALEDIR@
INIT=@INIT@
USE_NLS=@USE_NLS@

#=============================================================================
# List the directories you want to generate:
# DIRS for all, clean, etc.
# ALLDIRS for other such as documentation
#=============================================================================

DIRS= UTILS intl src po man 
FILES=./postinstall ./preremove ./postremove ./lpd.conf
ALLDIRS= ${DIRS} ${SRC}/TESTSUPPORT ${SRC}/HOWTO ${SRC}/DISTRIBUTIONS
SOMEDIRS= ${DIRS} ${SRC}/TESTSUPPORT ${SRC}/DISTRIBUTIONS

###############################################################################

all: ${DIRS} ${FILES}

SCRIPTS=init.bsdi init.freebsd init.linux init.solaris postinstall.bsdi postinstall.freebsd postinstall.generic postinstall.linux postinstall.solaris postremove.generic postremove.solaris preinstall.solaris preremove.freebsd preremove.generic preremove.linux preremove.solaris

$(SCRIPTS): header
	cat header ${SRC}/$@.sh >$@
	chmod 755 $@;

header: Makefile
	@echo "#!@SHELL@" >$@
	@echo LPD_PATH=$(LPD_PATH) >>$@
	@echo INSTALL=\"$(INSTALL)\" >>$@
	@echo LPD_PERMS_PATH=$(LPD_PERMS_PATH) >>$@
	@echo LPD_CONF_PATH=$(LPD_CONF_PATH) >>$@
	@echo PRINTCAP_PATH=$(PRINTCAP_PATH) >>$@
	@echo SYSCONFDIR=$(sysconfdir) >>$@
	@echo SBINDIR=$(sbindir) >>$@
	@echo FILTER_DIR=$(FILTER_DIR) >>$@
	@echo LOCKFILE=$(LOCKFILE) >>$@
	@echo PSHOWALL=\"$(PSHOWALL)\"  >>$@
	@echo "VERSION=$(VERSION)" >>$@
	@echo "INIT=$(INIT)" >>$@

./postinstall: $(SCRIPTS) Makefile
	OSNAME=@OSNAME@; case "@OSNAME@" in *linux* ) OSNAME=linux;; esac; \
	if test -f postinstall.$${OSNAME} ; then s=postinstall.$${OSNAME} ; else s=postinstall.generic; fi; \
	echo POSTINSTALL "'$$s'"; cp $$s postinstall;

./preremove: $(SCRIPTS) Makefile
	OSNAME=@OSNAME@; case "@OSNAME@" in *linux* ) OSNAME=linux;; esac; \
	if test -f preremove.$${OSNAME} ; then s=preremove.$${OSNAME} ; else s=preremove.generic; fi; \
	echo PREREMOVE "'$$s'"; cp $$s preremove;

./postremove: $(SCRIPTS) Makefile
	OSNAME=@OSNAME@; case "@OSNAME@" in *linux* ) OSNAME=linux;; esac; \
	if test -f postremove.$${OSNAME} ; then s=postremove.$${OSNAME} ; else s=postremove.generic; fi; \
	echo POSTREMOVE "'$$s'"; cp $$s postremove;

# define default target
.PHONY: all warn TAGS clean uninstall install  info dvi check \
	realclean mostlyclean distclean dist update ci cifiles FRC

MAKETARGET=all

###############################################################################
$(ALLDIRS): FRC
	if [ "$@" != po -o "$(USE_NLS)" != "no" ] ; then \
		cd $@; $(MAKE) localedir=${DESTDIR}${LOCALEDIR} \
			DESTDIR=$(DESTDIR) $(MAKETARGET) ; \
	fi

FRC:

TAGS clean:: FRC
	-$(MAKE) MAKETARGET=$@ DESTDIR=$(DESTDIR) $(DIRS)

clean::
	-rm -f header lpd.conf $(FILES) $(SCRIPTS) postinstall preremove postremove a.out
	-rm -f *.bak

install: all
	$(MAKE) MAKETARGET=$@ DESTDIR=$(DESTDIR) $(DIRS)

	if [ "${POSTINSTALL}" != "NO" -a "${POSTINSTALL}" != "no" ] ; then \
		MAKEINSTALL=YES DESTDIR=$(DESTDIR) $(SHELL) postinstall ; \
	fi;

info dvi check:

./lpd.conf: src/lpd.conf
	cp src/lpd.conf $@
	chmod 644 $@

src/lpd.conf:
	cd src; $(MAKE) MAKETARGET=lpd.conf

realclean: distclean
	$(MAKE) MAKETARGET=$@ DESTDIR=$(DESTDIR) $(ALLDIRS)

mostlyclean distclean: clean
	$(MAKE) MAKETARGET=$@ DESTDIR=$(DESTDIR) $(SOMEDIRS)
	rm -f config.cache config.log config.status lpd.conf
	rm -f `find . -type f -name '*.in' -print | sed -e 's/.in$$//' -e /configure/d `

###############################################################################
uninstall:
	echo "you must uninstall by hand"

ci: cifiles
	for i in $(ALLDIRS); do \
		case $$i in \
		po | intl ) ;; \
		* ) $(MAKE) MAKETARGET=$@ $$i ;; \
		esac; \
	done;
	chmod 755 `find . -name install-sh -print`
	chmod 755 `find . -name mkinstalldirs -print`

#CI=
#CO=-kv
CO=-l

cifiles:
	for i in . $(ALLDIRS); do \
		if test ! -d $$i/RCS ; then \
			mkdir $$i/RCS; \
		fi; \
	done;
	checkin() { \
		rcs -l $$1; \
		ci $(CI) -mUpdate -t-Initial $$1; \
		yes |co $(CO) $$1; \
	}; \
	for i in * */Makefile intl/* po/* ; do \
		if test -f "$$i" ; then \
			case "$$i" in  \
			*.mo ) ;; \
			config.* ) ;; \
			configure ) ;; \
			* ) checkin $$i ;; \
			esac; \
		fi; \
	done;

###############################################################################
# Update the patch level when you make a new version
# do this before you start changes
# Don't even think about making this configurable, it is for
# distribution and update purposes only!
#  Patrick Powell
###############################################################################

update:
	sed -e 's/"/\\"/g' -e 's/.*/"&",/' LICENSE >src/include/license.h
	sed -e 's/"/\\"/g' -e 's/.*/"&",/' COPYRIGHT >src/include/copyright.h
	for i in VERSION ./src/include/patchlevel.h configure.in ; do \
		rcs -l $$i; chmod +w $$i; \
	done;
	DIR=`pwd | sed 's,.*/,,`; \
	DIRVER=` echo $${DIR} | sed 's,.*-,,'`; \
	echo DIR $${DIR}, DIRVER $${DIRVER}; \
	echo "#define PATCHLEVEL \"$${DIR}\"" >./src/include/patchlevel.h; \
	echo $${DIR} >VERSION; \
	S=`echo *.sh | sed -e 's/\.sh//g'`; \
	perl -spi -e "s,=.*,=$${DIRVER}, if(/^VERSION=/ or /^#.* VERSION=/); \
		s,^DISTNAME=.*,DISTNAME=$${DIR},; \
		s,^PORTNAME=.*,PORTNAME=$(PACKAGE),; \
		s,^PORTVERSION=.*,PORTVERSION=$${DIRVER},; \
		s,package name \".*\",package name \"$${DIR}\",; \
		s,^SCRIPTS=.*,SCRIPTS=$$S,;" \
		Makefile.in configure.in lpd.perms.in printcap.in src/Makefile.in \
		DISTRIBUTIONS/*/Makefile DISTRIBUTIONS/Free*/README.html \
		po/Makefile.in.in
	perl -spi -e 's,.*,"Project-Id-Version: $(PACKAGE) $(VERSION)\\n", if(/^"Project-Id/);' \
		po/*.po
	autoconf; autoheader; configure
	ci $(CI) -l -mUpdate -t-Initial Makefile HOWTO/Makefile src/Makefile
	for i in HOWTO man ; do \
		(cd $$i ; $(MAKE) $@ ); \
	done;
	for i in po ; do \
		(cd $$i ; $(MAKE) update-po ); \
	done

###############################################################################
# Make a gnutar distribution
#   - note that not all the source tree is sent out
#
###############################################################################

tar: distclean
	cp /dev/null /tmp/X
	for i in '*RCS*' \
	'*core' '*.orig' '*.old' '*.bak' '*.rej' '*.tex'  \
	'*.dvi' '*.log' '*.o'  \
	'*.a' '*,v*' '*intl/po2tbl.sed' '*po/POTFILES'  \
	'lpd.conf'  '*tags' \
	'pclbanner' 'psbanner' 'authenticate_pgp' 'readfilecount' \
	'removeoneline' 'setupauth' 'sserver' 'sclient' \
	'checkpc' 'lpr' 'lpd' 'lpq' 'lprm' \
	'lpc' 'lpbanner' 'lpf' 'lpraccnt' \
	'monitor' 'lp' 'cancel' 'lpstat' \
	'decode_args_with_sh' 'decode_args_with_perl' \
	'fixid' 'fixupdate' \
	'lpq_in_perl' 'lpr_in_perl' \
	'lprm_in_perl' 'make_lpd_conf' \
	'make_printcap_use' 'makeinc' \
	'read_conf' 'remote_active' \
	'test_read' 'DOWNDATE' \
	'header' \
	config.cache config.status config.log config.h \
		; do  echo "$$i" >>/tmp/X.LPRng; done
	rm -f */Makefile Makefile
	chmod 755 `find . -name install-sh -print`
	chmod 755 `find . -name mkinstalldirs -print`
	chmod -R +w .
	
	DIR=`pwd | sed 's,.*/,,'`; \
		cd ..; \
		tar zXcf /tmp/X.LPRng $${DIR}.tgz $${DIR}; \
		md5 $${DIR}.tgz | pgp -fast -u papowell@lprng > $${DIR}.tgz.md5

configure: configure.in
	autoconf
	autoheader

dist: update ci
	${MAKE} tar
