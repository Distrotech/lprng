<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
 <META NAME="GENERATOR" CONTENT="SGML-Tools 1.0.9">
 <TITLE> LPRng-HOWTO: Attaching Your Printer</TITLE>
 <LINK HREF="LPRng-HOWTO-4.html" REL=next>
 <LINK HREF="LPRng-HOWTO-2.html" REL=previous>
 <LINK HREF="LPRng-HOWTO.html#toc3" REL=contents>
</HEAD>
<BODY>
<A HREF="LPRng-HOWTO-4.html">Next</A>
<A HREF="LPRng-HOWTO-2.html">Previous</A>
<A HREF="LPRng-HOWTO.html#toc3">Contents</A>
<HR>
<H2><A NAME="installref"></A> <A NAME="s3">3. Attaching Your Printer</A></H2>

<P>When installing a printer,
the first step should be to make sure that the printer is actually
working independently of the software.
The following section outlines some simple diagnostics that you
can use to check printer connectivity.
<H2><A NAME="networkprinter"></A> <A NAME="ss3.1">3.1 Network Printers</A>
</H2>

<P>The most flexible and highest throughput printer interface is
via a network (TCP/IP) connection.
Most high performance printers have a built in network interface,
or you can attach them to a
<EM>printer server</EM>
box which provides a network interface.
Network print boxes can be obtained from
Hewlett Packard
(
<A HREF="http://www.hp.com">http://www.hp.com</A>),
Lantronix's
(
<A HREF="http://www.lantronix.com">http://www.lantronix.com</A>),
and Rose Electronics
(
<A HREF="http://www.rosel.com">http://www.rosel.com</A>).
<P>The network interface usually supports multiple network printing protocols.
The most common are the LPD (RFC1179), Socket API, APPsocket, SMB,
and Novell Netware interfaces. 
LPRng directly supports the LPD (RFC1179) and Socket API interfaces,
and you can use the 
<CODE>smbclient</CODE> program from the
<A HREF="LPRng-HOWTO-5.html#smb">Samba Software Package</A> for the SMB interface.
There are no plans to support the Novell Netware interface,
given the wide range of alternatives.
<H3>Socket API</H3>

<P>The most powerful network connection is via the the
Socket API.
The most common Socket API,
and a <I>de facto</I> standard,
is the one used by Hewlett Packard on their JetDirect cards,
which allows a TCP/IP connection to port 9100.
This is a TCP/IP port on the printer that provides
a direct connection to the print engine,
similar to a serial or parallel port.
This connection is usually full duplex and provides error messages
and status information during printing.
<P>The Socket API is extremely simple.
<OL>
<LI>The user establishes a connection to port 9100.
This connection may be refused if the printer is busy
printing a job.</LI>
<LI>Once the connection has been established,
the print job is sent over the connection.
During this transfer,
error messages may be returned over the data link.</LI>
<LI>After sending all the data,
the sender should do a
<I>half-close</I> of the connection.
This tells the printer that no more data will be sent.</LI>
<LI>After finishing printing the job,
the printer will close the connection.</LI>
</OL>
<P>You can use the
<A HREF="http://www.l0pht.com/~weld/netcat/">netcat</A>
utility by Hobbit <CODE>&lt;Hobbit@avian.org&gt;</CODE>
to test that this interface is available and working.
If <I>ellipse.ps</I> is a test file, then:
The simplest and easiest way to print a file to a network printer appears
<BLOCKQUOTE><CODE>
<PRE>
  nc printer.ip.addr 9100 &lt; file
Example:
  nc 10.0.0.25 9100 &lt; ellipse.ps
</PRE>
</CODE></BLOCKQUOTE>
<H3>LPD (RFC 1179) Protocol</H3>

<P>The second most common network print protocol is the
RFC1179 TCP/IP protocol.
This is described in detail in later sections of this document,
but basically consists of a
simple set of command and responses.
<OL>
<LI>A connection is made to TCP/IP port 515 on the printer.
As for the Socket API,
this connection may fail if the printer is busy printing
another job or has another network connection open.</LI>
<LI>Once the connection has been established,
a print request command is sent to the printer,
and if printing is allowed,
and acknowledgment will be received.</LI>
<LI>The files comprising the print job are sent to the printer.</LI>
<LI>The connection to the printer is closed.</LI>
</OL>
<P>During the job transfer no error information is returned,
or other status information.
This must be obtained by reconnecting to the printer and sending
a print status request.
This is a major weakness of the RFC1179 protocol.
<P>When the LPRng software package has been installed,
it is easy to check printing by using a command of the form:
<BLOCKQUOTE><CODE>
<PRE>
  lpr -Plp@ipaddr -Dnetwork file
Example:
  lpr -Plp@10.0.0.25 -Dnetwork ellipse.ps
</PRE>
</CODE></BLOCKQUOTE>
<P>The <CODE>-Plp@ipaddr</CODE> option will cause the <CODE>lpr</CODE> program to make a direct
connection to port 515  and send the print file using the RFC1179
protocol.
The <CODE>-Dnetwork</CODE> debugging option will cause detailed network status to be
displayed during this process.
<P>In addition to the <CODE>lpr</CODE> program,
the Perl <CODE>cheap_lpr</CODE> program can be used.
This and other test programs are in the LPRng Distribution <CODE>UTILS</CODE> directory.
<H3><A NAME="appsocket"></A> APPsocket</H3>

<P>The APPsocket interface is supported by Tektronix and some other printer
vendors.
It is similar to the Socket API,
with a couple of minor differences.
<OL>
<LI>The printer has two ports for network connections:
TCP port 9100 for TCP/IP stream connections and UDP port 9101 for UDP
packet connections.</LI>
<LI>When a 0 length UDP packet or a UDP packet containing only <CODE>CR/LF</CODE>
is sent to UDP port 9101, the printer will return a packet to the sender
containing print status information.
This information indicates the printers current status (busy, idle, printing)
and any error conditions.</LI>
<LI>To send a job to the printer,
a connection to port 9100 is made.
This connection will be refused while the printer is busy or has a connection
to another host.</LI>
<LI>When the TCP connection is established,
the job can be sent over the TCP stream.
When all of the job has been transferred,
the connection should be <I>shutdown</I> for sending data by the sender,
but remain open to received error messages or other information.</LI>
<LI>An end or job indication in the data stream will also act to terminate
the connection.
This means that if the PostScript CTRL-D (end of job) character is sent in
a job,  then the connection will be terminated.</LI>
<LI>Once all the data has been received and the job has finished printing,
the connection will be terminated by the printer.</LI>
</OL>
<P>The LPRng IFHP filter program has support for the APPsocket interface.
Also,
there are Perl or other programs which can communicate with the printer.
See
<A HREF="LPRng-HOWTO-5.html#P450">Tektronix P450 and Family</A> for details.
<H2><A NAME="secnetwork"></A> <A NAME="ss3.2">3.2 Network Print Server Boxes</A>
</H2>

<P>A ``network print server'' is usually a box
(external model) or card in a printer (internal model)
which has a network connection to a TCP network and
software to implement a LPD print server.
If it is an external model,
The parallel or serial port of
the printer is connected to the box,
and the print server may support multiple printers.
If it is an internal model,
the server is usually nothing more than a Network Interface Controller
and a ROM containing software that the microprocessor in the printer
uses.
<P>The print server may support multiple printing protocols,
such as
<A HREF="LPRng-HOWTO-6.html#rfc1179">RFC1179</A>
(TCP/IP printing using the LPD print protocol),
Novell Printer Protocols,
SMB print protocols,
and AppleTalk protocols.
One of the observed problems with Network Print servers is that while they
can usually support one protocol and one user at a time quite well,
when you try to use multiple protocols and/or multiple users try to transfer
print jobs to the printer,  the printer may behave in a very odd manner.
Usually this results in a printer failing to finish a job currently being
printed,
and unable to accept new jobs.
<P>Several of the newer models of print servers have
Simple Network Management Protocol (SNMP) agents built into them,
and can provide detailed information about their internal functions.
By using a SNMP manager such as SunNetmanage or HP-Openview,
you can monitor your network printers activities.
<P>I recommend that you use only a single protocol to send jobs to the printer.
If you can,  I also recommend that you use a print spooler and have only
a single host system send a job to the printer.
<P>My best advice on connecting to network printers is not to use the
the built-in LPD server,
but to use the direct TCP/IP connection to the print engine.
Usually this is done to particular TCP/IP port on the printer.
For the HP JetDirect and other HP products, this is usually
TCP port 9100.
<P>Once you have the direct connection,
you can now use various filters to preprocess the print job,
insert PJL and PCL commands,
or convert text to PostScript or PCL for better print quality.
<P>
<H2><A NAME="ss3.3">3.3 Parallel Printers</A>
</H2>

<P>In most UNIX systems the printer port has the name
<CODE>/dev/lpt</CODE>,
<CODE>/dev/prn</CODE>,
or something similar.
On most systems the
<CODE>dmesg</CODE> utility will print a list of IO devices found
during system configuration.
Use the following commands to get the information and scan
for the device.
You should also make sure that the printer device is
available.
<BLOCKQUOTE><CODE>
<PRE>
dmesg >/tmp/a
grep lp /tmp/a
ls /dev/lp*
</PRE>
</CODE></BLOCKQUOTE>
<P>
<P>Gordon Haverland
<CODE>&lt;haverlan@agric.gov.ab.ca</CODE>&gt; supplied this little script,
that will assist with this:
<BLOCKQUOTE><CODE>
<PRE>
#!/bin/sh
#set -v -x              # uncomment for debugging
PATH=/bin:/usr/bin
printer=
for $printer in /dev/lp* ;
do
    echo PRINTER TEST to $printer 1&gt;&amp;2
    for i in 1 2 3 4 5 6 7 8 9;
    do
        echo PRINTER $printer $i &gt; $printer;
    done
    echo -e \\r\\f &gt; $printer
done
exit 0;
</PRE>
</CODE></BLOCKQUOTE>
<P>If your printer is connected to the device name you provided,
then you should get a page of something out.  If the output
suffers from the ``staircase'' effect, you will see the numbers
``marching'' across the page, otherwise the numbers will all be in
a single column.
<H2><A NAME="secserial"></A> <A NAME="ss3.4">3.4 Serial Printers</A>
</H2>

<P>If your printer is attached by a serial line,
then you may need to set the serial line characteristics before sending
the job to the printer.
Here are a set of guidelines to following when attaching a serial port printer
to a serial line.
<P>1. Check to make sure that the line is not enabled for login.
Logins are usually managed by the
<CODE>getty</CODE> (BSD)
or
<CODE>ttymon</CODE> (Solaris, SystemV).
Check your system documentation and make sure that these daemons are not
managing the serial line.
<P>2. Check the permissions and ownership of the serial line.
For the most easy testing,
set the permissions to 0666 (everybody can open for reading and writing).
After you have made sure that you can send jobs to the printer,
you might want to change the ownership of the serial line to the LPD server
and change the permissions to 0600.
<P>3. Make sure that you can print a test file on the printer via the
serial port.
This may require setting the line characteristics and then sending
a file to the printer.
You should try to use 8 bit, no parity, with hardware flow control
and no special character interpretation,
and definitely no LF to CR/LF translation.
The problem is that different versions of UNIX systems have different
sets of stty(1) commands to do this.
The following simple test script can help in this.
<BLOCKQUOTE><CODE>
<PRE>
#!/bin/sh
# 9600, no echo, no CR
FLAGS= 9600 -raw -parenb cs8 crtscts
DEV= /dev/tty01
(stty $FLAGS; stty 1>&amp;2; cat $1 ) &lt;$DEV >$DEV
</PRE>
</CODE></BLOCKQUOTE>
<P>This shows using stty to set the flags,
then to print the current settings, and then using
cat a file to the output.
If you attach a dumb terminal to the serial port,
you can even use this script to ensure that input from the device
is echoed to the output with the correct speed, parity,
etc.
<P>Experience has shown that serially connected printers are the least
reliable and lowest speed.
Where possible,
it is strongly recommended that they be attached to a <I>network print box</I>
which will provide a
Socket API interface and handle the low level network to serial port protocol 
conversions.
<HR>
<A HREF="LPRng-HOWTO-4.html">Next</A>
<A HREF="LPRng-HOWTO-2.html">Previous</A>
<A HREF="LPRng-HOWTO.html#toc3">Contents</A>
</BODY>
</HTML>
