<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
 <META NAME="GENERATOR" CONTENT="SGML-Tools 1.0.9">
 <TITLE> LPRng-HOWTO: Spool Queues and Files</TITLE>
 <LINK HREF="LPRng-HOWTO-11.html" REL=next>
 <LINK HREF="LPRng-HOWTO-9.html" REL=previous>
 <LINK HREF="LPRng-HOWTO.html#toc10" REL=contents>
</HEAD>
<BODY>
<A HREF="LPRng-HOWTO-11.html">Next</A>
<A HREF="LPRng-HOWTO-9.html">Previous</A>
<A HREF="LPRng-HOWTO.html#toc10">Contents</A>
<HR>
<H2><A NAME="cd"></A> <A NAME="sd"></A> <A NAME="s10">10. Spool Queues and Files</A></H2>

<P>When files are accepted by the <CODE>lpd</CODE> server for printing,
they are stored in a spool queue directory,
together with other files controlling the print operation.
This section describes these files and how the LPRng software uses them.
<P>For descriptive purposes,
we will use the following printcap entry as a guide:
<P>
<BLOCKQUOTE><CODE>
<PRE>
pr|alias
  :sd=/var/lpd/pr_public
  :cd=/var/lpd/pr
</PRE>
</CODE></BLOCKQUOTE>
<H2><A NAME="ss10.1">10.1 Spool Queue</A>
</H2>

<P>
<UL>
<LI> <CODE>sd=</CODE><EM>Spool queue directory name</EM></LI>
</UL>
<P>The
<CODE>sd</CODE>
option in the printcap entry specifies the spool queue
directory.
If there is no
<CODE>sd</CODE>
entry or value,
then the printer can only be used by the clients such as <CODE>lpr</CODE>
to locate the destination for a print job.
All information,
files,
etc.,
for a print queue is stored in the spool directory.
<H2><A NAME="queue_lock_file"></A> <A NAME="ss10.2">10.2 Queue Lock File</A>
</H2>

<P>
<UL>
<LI> <CODE>spool_lock_file</CODE><EM>&nbsp;&nbsp;spool queue lock file - default %P</EM></LI>
</UL>
<P>When the <CODE>lpd</CODE> server starts printing,
it will fork individual worker processes to service each queue.
To prevent multiple processes from working on the same queue,
a printer lock file specified by the
<CODE>queue_lock_file</CODE> option
(default <CODE>%P</CODE> - the %P is expanded to the print queue name)
is used.
In our example,
the lock file would be:
<CODE>/var/lpd/pr/pr</CODE>.
<P>The process ID of the currently active printer is stored in the lock file.
By reading the lock file and testing to see if the process is still active,
programs such as <CODE>lpq</CODE> can determine queue activity.
<P>Similarly,
the worker process may need to create other processes to assist it.
These in turn will create lock or temporary files in the spool directory
as well.
<H2><A NAME="queue_control_file"></A> <A NAME="ss10.3">10.3 Spool Control File</A>
</H2>

<P>
<UL>
<LI> <CODE>spool_control_file</CODE><EM>&nbsp;&nbsp;spool queue control file - default control.%P</EM></LI>
</UL>
<P>The spool control file is used to control the operations of the
spooler,
and is in the spool or control directory.
The file name specified by the
<CODE>queue_control_file</CODE> option
(default <CODE>control.%P</CODE> - the %P is expanded to the print queue name);
in our example,
the control file would be:
<CODE>/var/lpd/pr/control.pr</CODE>.
<P>The <CODE>lpc</CODE> program sends spool control requests to the
<CODE>lpd</CODE> daemon,
which updates the control file and then signals the appropriate
spool server processes that an update has been performed.
The control file contents have the form:
<BLOCKQUOTE><CODE>
<PRE>
key value
</PRE>
</CODE></BLOCKQUOTE>
<P>The following keys and their values are currently supported.
<P><CODE>printing_disabled&nbsp;&nbsp;&nbsp;</CODE>
<CODE>0 or 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE>
<CODE>disable printing of jobs in queue</CODE> <BR>
<CODE>spooling_disabled&nbsp;&nbsp;&nbsp;</CODE>
<CODE>0 or 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE>
<CODE>disable placing jobs in queue</CODE> <BR>
<CODE>holdall&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE>
<CODE>0 or 1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE>
<CODE>hold jobs until released</CODE> <BR>
<CODE>redirect&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE>
<CODE>printer&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE>
<CODE>transfer jobs to indicated printer</CODE> <BR>
<CODE>class&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE>
<CODE>glob expression&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE>
<CODE>print only jobs whose class matches glob expression</CODE> <BR>
<CODE>server_order&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE>
<CODE>printer name list&nbsp;&nbsp;&nbsp;</CODE>
<CODE>preferred order of printer use</CODE> <BR>
<CODE>debug&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</CODE>
<CODE>debugging options&nbsp;&nbsp;&nbsp;</CODE>
<CODE>debugging and tracing</CODE> <BR>
<P>The <CODE>printing_disabled</CODE> and <CODE>spooling_disabled</CODE>
are managed using the <CODE>lpc start</CODE>, <CODE>lpc stop</CODE>,
<CODE>lpc enable</CODE> and <CODE>lpc disable</CODE>
commands.
Similarly,
<CODE>holdall</CODE> is enabled and disabled by <CODE>holdall</CODE> and
<CODE>noholdall</CODE>
commands respectively.
When holdall is enabled,
jobs placed in the print queue will be held until they are explicitly
released for printing by an <CODE>lpc release</CODE> command.
<P>The <CODE>redirect</CODE> entry is used to redirect or transfer jobs
which are spooled to this queue to another queue,
and is managed by the redirect command.
The <CODE>lpc redirect off</CODE> removes the redirect entry from the
control file.
<P>The <CODE>class</CODE> entry is similar in operation to the
<CODE>holdall</CODE>,
but allows jobs whose class identification matches the glob
expression to be printed.
This can be useful when you have special forms or paper required for a
print job,
and want to run only these jobs when the paper is in the printer.
<P>The <CODE>server_order</CODE>
entry is created and updated for a multiple printer queue.
It records the order in which printers should next be used
for normal print operations.
This allows <EM>round robin</EM> use of printers,
rather than having all jobs printed to the first printer in the
list of printers.
<P>The <CODE>debug</CODE>
entry is set by the <CODE>lpc debug</CODE> command,
and is used to enable or disable debugging and tracing information
for a spool queue.
This facility is for diagnostic purposes only.
<H2><A NAME="queue_status_file"></A> <A NAME="createfiles"></A> <A NAME="minlogfilesize"></A> <A NAME="maxlogfilesize"></A> <A NAME="minstatussize"></A> <A NAME="maxstatussize"></A> <A NAME="maxstatusline"></A> <A NAME="short_status_date"></A> <A NAME="ps"></A> <A NAME="lf"></A> <A NAME="ss10.4">10.4 Log and Status Files</A>
</H2>

<P>
<UL>
<LI> <CODE>create_files</CODE><EM>&nbsp;&nbsp;create log, accounting and status files</EM></LI>
<LI> <CODE>lf=</CODE><EM>log file name (default: log)</EM></LI>
<LI> <CODE>max_log_file_size#</CODE><EM>&nbsp;&nbsp;maximum log file size (Kbytes)</EM></LI>
<LI> <CODE>min_log_file_size#</CODE><EM>&nbsp;&nbsp;minimum log file size (Kbytes)</EM></LI>
<LI> <CODE>max_status_line#</CODE><EM>&nbsp;&nbsp;maximum status line length (characters) </EM></LI>
<LI> <CODE>max_status_size#</CODE><EM>&nbsp;&nbsp;maximum status file size (Kbytes)</EM></LI>
<LI> <CODE>min_status_size#</CODE><EM>&nbsp;&nbsp;minimum status file size (Kbytes)</EM></LI>
<LI> <CODE>ps=</CODE><EM>filter status file name (default: status)</EM></LI>
<LI> <CODE>queue_status_file=</CODE><EM>queue status file (default: status.%P)</EM></LI>
<LI> <CODE>short_status_date=</CODE><EM>display short (hh:mm) timestamp (default: true)</EM></LI>
</UL>
<P>During operation,
the <CODE>lpd</CODE> server records the current printing operations
in the spool queue status file specified by the <CODE>spool_status_file</CODE> option
(default <CODE>status.%P</CODE> - the %P is expanded to the print queue name);
for our example, this would be
<CODE>/var/lpd/pr/status.pr</CODE>.
In order to prevent this file from growing too large,
the server will periodically truncate the file.
You can force creation of these files by setting the
<CODE>create_files</CODE> option.
The
<CODE>max_status_size</CODE> configuration or printcap option
sets the maximum size (in Kbytes) of the status file;
if the file exceeds this,  only the last
<CODE>min_status_size</CODE> bytes
or 25% of the maximum size (default if not specified)
will be preserved.
<P>Similarly,
the server logs its operations in the log file specified by the
<CODE>lf</CODE> (log file) option (default is <CODE>lf=log</CODE>).
The <CODE>max_log_file_size</CODE>
value
(default 0)
specifies the maximum length
of the log file in Kbytes.
If this value is non-zero,
then the log file is truncated to
<CODE>min_log_file_size</CODE> bytes
or 25% of the maximum file size.
Again, the last portion of the log file is preserved.
If the <CODE>max_log_file_size</CODE> value is 0,
then the log file grows without limit.
<P>Some filters require an additional filter status file
that they use for recording additional filter status or
other operational information.
The
<CODE>ps</CODE> names this file,
and it is passed to a print filter using the <CODE>$s</CODE>
option
(see
<A HREF="LPRng-HOWTO-13.html#filtercmd">Filter Command Line Flags</A>).
<P>The STDERR output for filters is put into the printer
status file.
This allows the filter to produce informative messages that can be displayed
as part of the user status.
In addition,
a separate status file specified by the
<CODE>ps</CODE> (Printer Status) can be used as well.
This file is 
<EM>not</EM>
truncated by the LPRng system.
<P>When reporting status information,
the length of line returned can be a problem.
The <CODE>max_status_line#79</CODE> option restricts the status line
to a maximum of 79 characters.
<P>The <CODE>short_status_date</CODE> (default is true)
option causes short (hour:minute) timestamps to be displayed
on status queries.
<H2><A NAME="ss10.5">10.5 Job Files</A>
</H2>

<P>
<A NAME="nline_after_file"></A> 
<UL>
<LI> <CODE>longnumber</CODE><EM>&nbsp;&nbsp; long job number</EM></LI>
<LI> <CODE>default_priority=</CODE><EM>default job priority</EM></LI>
<LI> <CODE>nline_after_file=</CODE><EM>N line after data file</EM></LI>
</UL>
<P>A print job consists of a control file and one or more data files.
<A HREF="LPRng-HOWTO-6.html#rfc1179">RFC1179</A>
specifies the general format of these files and how they are to be
transfered between servers.
LPRng has extended the contents of the control files and the transfer protocol
to provide a more powerful set of features,
but has extensive provisions for backwards compatibility with
non-LPRng software.
A sample control file is shown below:
<BLOCKQUOTE><CODE>
<PRE>
Hastart4.astart.com
J/tmp/file1 /tmp/file2
CA
Lpapowell
Ppapowell
fdfA002230astart4.astart.com
N/tmp/file1
UdfA002230astart4.astart.com
fdfB002230astart4.astart.com
N/tmp/file2
UdfB002230astart4.astart.com
</PRE>
</CODE></BLOCKQUOTE>
<P>The first part of the control file contains general information generated
by the <CODE>lpr</CODE> or other spooling program.
The information lines start with an uppercase letter or digit.
Some other spooling systems also start information lines with
various punctuation marks such as underscores (_) or periods (.).
<P>Following this are a set of entries about each of the various files to
be printed.
These lines start with a lower case letter,
followed by the print file name.
The lower case letter is the
<EM>format</EM> to be used to process the file.
See
<A HREF="LPRng-HOWTO-12.html#format">print file formats</A>
for more information about its use.
<P>
<CENTER><TABLE BORDER><TR><TD>
<BR>
Key</TD><TD>Meaning</TD><TD>Generated By</TD></TR><TR><TD>
A</TD><TD>identifier *</TD><TD>LPRng internal</TD></TR><TR><TD>
C</TD><TD>class</TD><TD>lpr -C class</TD></TR><TR><TD>
D</TD><TD>date</TD><TD>lpr</TD></TR><TR><TD>
H</TD><TD>originating host</TD><TD>lpr</TD></TR><TR><TD>
I</TD><TD>indent</TD><TD>lpr -i indent</TD></TR><TR><TD>
J</TD><TD>jobname</TD><TD>lpr -J jobname (default: list of files)</TD></TR><TR><TD>
L</TD><TD>bnrname</TD><TD>lpr -U username</TD></TR><TR><TD>
N</TD><TD>filename</TD><TD>(see text)</TD></TR><TR><TD>
M</TD><TD>mailname</TD><TD>lpr -m mailname</TD></TR><TR><TD>
P</TD><TD>logname</TD><TD>lpr</TD></TR><TR><TD>
Q</TD><TD>queuename</TD><TD>lpr -Q</TD></TR><TR><TD>
R</TD><TD>accntname</TD><TD>lpr -R accntname</TD></TR><TR><TD>
S</TD><TD>slinkdata *</TD><TD>lpr</TD></TR><TR><TD>
T</TD><TD>prtitle</TD><TD>lpr -T prtitle</TD></TR><TR><TD>
U</TD><TD>unlnkfile</TD><TD>(see text)</TD></TR><TR><TD>
W</TD><TD>width</TD><TD>lpr -w width</TD></TR><TR><TD>
Z</TD><TD>zopts *</TD><TD>lpr -Z zopts</TD></TR><TR><TD>
1</TD><TD>font1</TD><TD>lpr -1 font1</TD></TR><TR><TD>
2</TD><TD>font2</TD><TD>lpr -2 font2</TD></TR><TR><TD>
3</TD><TD>font3</TD><TD>lpr -3 font3</TD></TR><TR><TD>
4</TD><TD>font4</TD><TD>lpr -4 font4</TD></TR><TR><TD>

</TD></TR></TABLE></CENTER>
<P>The entries marked with * are used only by LPRng.
<CODE>N</CODE> and <CODE>U</CODE> lines
are associated with a print file.
The <CODE>N</CODE> line is the original name of the print
file.
By default,
LPRng places this line <I>before</I>
the corresponding data file.
You can use the
<CODE>nline_after_file</CODE>
option to have LPRng place the N line after the data file line.
The <CODE>U</CODE> line originally was used to indicate that the
named file was to be unlinked after printing.
This information is now ignored by LPRng.
These lines are always grouped with a print file entry.
<P>The names of control and data files follow a very strict pattern.
Control files have the format <CODE>cfX<EM>number</EM><B>host</B></CODE>,
where X is an upper case letter,
<EM>number</EM> is (usually) a 3 digit number,
and <B>host</B> is the host name.
<A HREF="LPRng-HOWTO-6.html#rfc1179">RFC1179</A>
restricted the total length of the control file name to 32 characters;
LPRng has a much looser limit.
<P>Data file names must follow the same pattern as the control file name,
and have the format
<CODE>dfX<EM>number</EM><B>host</B></CODE>.
The X can be in the range A-Za-z,
allowing at most 52 data files for a job.
The <EM>number</EM> and <B>host</B> must be identical to the corresponding
control file.
<P>By convention,
LPRng uses the X of the control file name to set a priority for the
job.
A job with control file name
<CODE>cfA...</CODE>
will have <EM>lower</EM> format
than a job with format
<CODE>cfB...</CODE>,
and so forth.
The <CODE>lpr</CODE> program uses the first letter of the class name
or an explicit priority indication to set the letter value.
If none of these are specified, then the
<CODE>default_priority</CODE> value from the configuration or printcap
entry is used.
<P>The job number is usually a 3 digit value.
However,
in systems where a large number of jobs are spooled and need to be
kept for printing at scheduled times,
this can lead to problems.
The
<CODE>longnumber</CODE>
option will use 6 digit job numbers.
This must be used with care when operating with non-LPRng software.
<H2><A NAME="ss10.6">10.6 Job Hold File</A>
</H2>

<P>Associated with each control file is a
hold file that has additional information controlling the printing operations.
The entries in this file have the form:
<BLOCKQUOTE><CODE>
<PRE>
key [value]
</PRE>
</CODE></BLOCKQUOTE>
<P>The following is an example of a hold file:
<BLOCKQUOTE><CODE>
<PRE>
server 0
subserver 0
attempt 3
error cannot open printer
hold 0
priority 0
remove 0
routed 0
</PRE>
</CODE></BLOCKQUOTE>
<P>The
<CODE>server</CODE>
and
<CODE>subserver</CODE>
entry records the process ID of the server process
and the subserver process that is printing the job.
The
<CODE>attempt</CODE>
field records the total number of attempts to print the job.
The
<CODE>error</CODE>
field records any error that would prevent the job from being printed.
This information is reported by the <CODE>lpq</CODE> program.
<P>The
<CODE>hold</CODE>
field is non-zero when the
<CODE>lpc hold</CODE>
command is used to
explicitly prevent the job from being printed;
<CODE>lpc release</CODE>
will clear the field and allow the job to be printed.
<P>The
<CODE>priority</CODE>
field is modified by the
<CODE>lpc topq</CODE>
command and is used to provide an overriding priority to printing the file.
<P>The
<CODE>remove</CODE>
field is non-zero when the file has been printed and should be removed.
<P>The
<CODE>routed</CODE>
field is used to indicate that there is routing information present in
the hold file,
and that special handling is needed.
The routing information is provided by a
<A HREF="LPRng-HOWTO-8.html#routing">routing filter</A>.
The information is recorded by information in the hold file.
The following is an example of routing information.
Normally this information is stored in a URL escaped format,
with one line per destination,
but for clarity this has been broken out into plain text form:
<P>
<BLOCKQUOTE><CODE>
<PRE>
active 0
attempt 0
done 0
hold 0
priority 0
remove 0
routed 880892602
route 1
  dest t1
  ident papowell@astart4+705.1
  error 
  copies 1
  copy_done 0
  status 0
  active 0
  attempt 0
  done 0
  hold 0
  sequence 0
  priority B
  CB
  end 
route 2
  dest t1
  ident papowell@astart4+705.2
  error 
  copies 0
  copy_done 0
  status 0
  active 0
  attempt 0
  done 0
  hold 0
  sequence 1
  end 
</PRE>
</CODE></BLOCKQUOTE>
<P>Routing information lines start with
<CODE>route</CODE> followed by individual routing entry information.
The <CODE>route</CODE> <CODE>dest</CODE>,
<CODE>copies</CODE>,
<CODE>priority</CODE>,
and
<CODE>Xnnnn</CODE>
entries are
derived from the output of the router program;
other fields are used during the printing process.
The <CODE>copy_done</CODE> records the numbers of copies done,
while the <CODE>done</CODE> records that the entry has been completed.
The <CODE>status</CODE> is the process ID of the server process
doing the printing.
<P>The output from  route filter  that generated the above file was:
<BLOCKQUOTE><CODE>
<PRE>
dest t1
copies 1
priority B
CB
end
dest t1
end
</PRE>
</CODE></BLOCKQUOTE>
<H2><A NAME="ah"></A> <A NAME="ss10.7">10.7 Job State</A>
</H2>

<P>Options used:
<UL>
<LI> <CODE>ah</CODE><EM>&nbsp;&nbsp;Automatically hold jobs</EM></LI>
</UL>
<P>A job can be in the following state:
<OL>
<LI>Initial.
This is the state during job submission.
Jobs in the initial state do not have any status displayed for them.</LI>
<LI>Held.
Once a job is submitted,
it can either be printed or <EM>held</EM>.
The <CODE>ah</CODE> printcap option specifies that all jobs are
automatically held on submission.
The
<CODE>lpc release</CODE>
and
<CODE>lpc redo</CODE>
command will cause these jobs to be printed and
the <CODE>lprm</CODE> command can remove these jobs.</LI>
<LI>Active.
The job is being processed for printing or transfer to another queue.</LI>
<LI>Pending.
Jobs which can be printed but are not active.
This can be due to the printer being busy or
the job <B>class</B> not being printed.</LI>
<LI>Error.
Jobs which have encountered an error during printing.
The
<CODE>lpc release</CODE>
and
<CODE>lpc redo</CODE>
command will cause these jobs to be printed and
the <CODE>lprm</CODE> command can remove these jobs.</LI>
<LI>Done.
Jobs which have completed printing,
but which are not yet removed from the print queue.
See the
<CODE>
<A HREF="LPRng-HOWTO-12.html#savewhendone">save_when_done</A></CODE>
flag for more information.
The <CODE>lprm</CODE> command can remove these jobs.</LI>
</OL>
<P>Normally the job sequences is initial, pending, active, and done.
However, a job may be put in the error state by problems processing the job
or by actions of the <CODE>lpc</CODE> command.
<H2><A NAME="useidentifier"></A> <A NAME="ss10.8">10.8 Job Identifier</A>
</H2>

<P>Options:
<UL>
<LI> <CODE>use_identifier</CODE><EM>&nbsp;&nbsp;put job identifier in control file</EM></LI>
</UL>
<P>For each job in a spool queue,
the LPRng software creates a unique identifier.
This identifier is recorded in the control file <CODE>A</CODE> line.
It can be used by the various client programs for identifying jobs,
and is displayed by the <CODE>lpq</CODE> program as status information.
<HR>
<A HREF="LPRng-HOWTO-11.html">Next</A>
<A HREF="LPRng-HOWTO-9.html">Previous</A>
<A HREF="LPRng-HOWTO.html#toc10">Contents</A>
</BODY>
</HTML>
