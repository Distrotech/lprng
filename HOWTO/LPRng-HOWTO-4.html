<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
 <META NAME="GENERATOR" CONTENT="SGML-Tools 1.0.9">
 <TITLE> LPRng-HOWTO: Installing the Software</TITLE>
 <LINK HREF="LPRng-HOWTO-5.html" REL=next>
 <LINK HREF="LPRng-HOWTO-3.html" REL=previous>
 <LINK HREF="LPRng-HOWTO.html#toc4" REL=contents>
</HEAD>
<BODY>
<A HREF="LPRng-HOWTO-5.html">Next</A>
<A HREF="LPRng-HOWTO-3.html">Previous</A>
<A HREF="LPRng-HOWTO.html#toc4">Contents</A>
<HR>
<H2><A NAME="installation"></A> <A NAME="installingprograms"></A> <A NAME="s4">4. Installing the Software</A></H2>

<P>The basic components of the LPRng system are the executables
and the database files.
This section deals with generating and installing the executable
files.
<H2><A NAME="ss4.1">4.1 Source Code and Support Programs</A>
</H2>

<P>
<OL>
<LI>Obtain the latest version of the LPRng source code from a
<A HREF="LPRng-HOWTO-1.html#secftp">LPRng FTP Site</A>.</LI>
<LI>Obtain the GNU Zip (compression) program from one of the many
<A HREF="http://prep.ai.mit.edu">GNU Software Mirror Sites</A>
and install it.
See the directions in the GNU Zip distribution for details.</LI>
<LI>Obtain the GNU Make program from one of the many
<A HREF="http://prep.ai.mit.edu">GNU Software Mirror Sites</A>.
and install it.
See the directions in the GNU Zip distribution for details.
This program will be referred to as
<CODE>gmake</CODE> in the installation instructions.</LI>
<LI>Obtain an ANSI C compiler.
The GCC compiler (from the 
<A HREF="http://prep.ai.mit.edu">GNU Software Mirror Sites</A>)
is strongly recommended.</LI>
<LI>Solaris Sparc and X86 Binaries for GCC and Make  can be obtained from
<A HREF="http://smc.vnet.net/">http://smc.vnet.net/</A>.</LI>
</OL>
<H2><A NAME="ss4.2">4.2 Configuration</A>
</H2>

<P>
<P>The LPRng package consists of:
<UL>
<LI> <EM><CODE>lpd</CODE></EM> - the LPD print server program</LI>
<LI><EM><CODE>lpr</CODE></EM>,
<EM><CODE>lpq</CODE></EM>,
<EM><CODE>lprm</CODE></EM>,
<EM><CODE>lpstat</CODE></EM>,
and
<EM><CODE>lpc</CODE></EM> -
client programs for printing,
status queries, job removal, and server configuration respectively.</LI>
<LI><EM><CODE>printcap</CODE></EM> print queue database file.</LI>
<LI><EM><CODE>lpd.conf</CODE></EM> LPRng configuration options.</LI>
<LI><EM><CODE>lpd.perms</CODE></EM> permission information.</LI>
</UL>
<P>By tradition,
UNIX systems have installed printer utilities in
in widely varied locations such as
<CODE>/usr/lib</CODE>,
<CODE>/usr/bin</CODE>,
<CODE>/usr/libexec</CODE>,
<CODE>/usr/ucb</CODE>,
<CODE>/opt</CODE>,
<CODE>/usr/sbin</CODE>,
and
<CODE>/usr/etc/</CODE>.
This can lead to a great deal of confusion when installation LPRng.
To simplify the installation,
the <CODE>configure</CODE> program is used to specify the exact locations
of programs.
It does this by setting the following variables that are
used during the installation process:
<BLOCKQUOTE><CODE>
<PRE>
Installation directory variables:
  ${prefix}  (default /usr/local)
  ${exec_prefix}  (default ${prefix})
  ${bindir}  is usually ${exec_prefix}/bin, (/usr/local/bin)
  ${sbindir} is usually ${exec_prefix}/sbin (/usr/local/sbin)
  ${libexecdir} is usually ${exec_prefix}/libexec (/usr/local/libexec)
  ${sysconfdir} is usually ${prefix}/etc (/usr/local/etc)
  ${mandir} is usually ${prefix}/man     (/usr/local/man)
</PRE>
</CODE></BLOCKQUOTE>
<P>These values are used as follows by the LPRng installation
procedures (* indicates default SETUID root executable):
<BLOCKQUOTE><CODE>
<PRE>
Executables:
  ${bindir}/   lpr *, lprm *, lpq *, lpstat *
  ${sbindir}/  lpc *, checkpc, lpd *
  ${libexecdir}/filters/ lpf, banner, etc
Configuration:
  ${sysconfdir}/ lpd.conf, lpd.perms, printcap
Man Pages
  ${mandir}/ man pages
</PRE>
</CODE></BLOCKQUOTE>
<P>The <CODE>configure</CODE> program has options which allow us to override and
specify the new values or exact locations for these files.
For a complete list of configuration options,
use the <CODE>configure --help</CODE> option.
You can set explicit values for the
<CODE>prefix</CODE>
<CODE>bindir</CODE>
<CODE>sbindir</CODE>
<CODE>libexecdir</CODE>
and
<CODE>mandir</CODE> variables using the <CODE>--name=PATH</CODE>
option.
For example,
<CODE>/configure --prefix=/usr</CODE> will set the
<CODE>${prefix}</CODE> variable to <CODE>/usr</CODE>,
and files will be installed in
<CODE>/usr/bin</CODE>,
<CODE>/usr/sbin</CODE>,
<CODE>/usr/libexec/filter</CODE>,
and
<CODE>/etc</CODE>.
<P>In addition to these general purpose options,
the <CODE>configure</CODE> script has the following LPRng specific ones.
These options allow extremely specific actions to be taken to control
how and were the various files are copied and used.
<DL>
<DT><B><CODE>--disable-setuid</CODE></B><DD><P>Install the executables without setuid ROOT permissions.
<DT><B><CODE>--disable-strip</CODE></B><DD><P>Do not strip the executables before installing.
<DT><B><CODE>--enable-priv_ports.</CODE></B><DD><P>Require connections to be made from a privileged port.
<DT><B><CODE> --disable-force_localhost.  </CODE></B><DD><P>By default,
the LPRng software is configured to expect to have a server running
on the local host.
This option will cause the location of the server to be obtained from the
<CODE>lpd.conf</CODE> or <CODE>printcap</CODE> information.
<DT><B><CODE> --with-lpddir=DIR.  </CODE></B><DD><P>lpd executable directory (default ${sbindir}).
<DT><B><CODE> --with-filterdir=DIR.  </CODE></B><DD><P>Filter directory (default ${libexecdir}/filters).
<DT><B><CODE> --with-lpd_conf_path=PATH.  </CODE></B><DD><P>Path of <CODE>lpd.conf</CODE> file.
<DT><B><CODE> --with-lpd_perms_path=PATH </CODE></B><DD><P>Path of <CODE>lpd.perms</CODE> file.
<DT><B><CODE> --with-printcap_path=PATH </CODE></B><DD><P>Path of <CODE>printcap</CODE> file.
</DL>
<H2><A NAME="ss4.3">4.3 Installation</A>
</H2>

<P>Unpack,  configure,
compile, and install,
and initialize the distribution using:
<BLOCKQUOTE><CODE>
<PRE>
gunzip -c LPRng-&lt;version>.tgz | tar xvf -
cd LPRng-&lt;version>
# see discussion above for configuration options
# This configuration uses the standard /etc/printcap file
./configure --with-printcap_path=/etc/printcap
           [with other options as required]
gmake clean all
su   # you must do the following commands as root
gmake install
# if  you have not installed LPRng before,
# install default lpd.perms and lpd.conf file in /etc
if [ ! -f /etc/lpd.perms ]; then
    make default;
fi;
# update permissions,  create files needed for LPRng, check
# /etc/printcap file for problems.  Do as root:
./src/checkpc -f
</PRE>
</CODE></BLOCKQUOTE>
<P>
<H2><A NAME="ss4.4">4.4 Solving Installation Problems</A>
</H2>

<P>The <CODE>configure</CODE>
script will determine the type of system and establish a set of defaults
for compilation and installation.
The <CODE>LPRng/INSTALL</CODE>
file contains detailed descriptions of the various configuration options and
capabilities.
<P>If you have problems compiling the package, you can try these things:
<OL>
<LI>Compiler complains about missing files or has a large number of
errors.<BR>
Try <CODE>gcc</CODE> instead of your vendor's C compiler.
This can be done either by setting
the
<CODE>CC</CODE> environment variable or using the
<CODE>--with-cc</CODE> configure option.
<BLOCKQUOTE><CODE>
<PRE>
CC=gcc ./configure
   OR
configure --with-cc=gcc
</PRE>
</CODE></BLOCKQUOTE>

</LI>
<LI>Missing libraries or include files.<BR>
Usually this is caused when include files are in
<CODE>/usr/local/include</CODE>
and libraries are in
<CODE>/usr/local/include</CODE>
and these paths are not searched or used by the compiler.
This can be fixed by setting the
<CODE>CPPFLAGS</CODE> and <CODE>LDFLAGS</CODE> environment variables,
or using the
<CODE>--with-cppopts=</CODE>
and
<CODE>--with-ldopts=</CODE>
configure options.
<BLOCKQUOTE><CODE>
<PRE>
CPPFLAGS="-I/usr/local/include -I/usr/include/kerberosIV" \
  LDFLAGS="-L/usr/local/lib -L/usr/lib/kerberosIV" \
  ./configure
   OR
configure --with-cppopts="-I/usr/local/include -I/usr/include/kerberosIV" \
  --with-ldopts="-L/usr/local/lib -L/usr/lib/kerberosIV"
</PRE>
</CODE></BLOCKQUOTE>
</LI>
</OL>
<P>The <CODE>configure</CODE> and <CODE>make</CODE> steps must be run on
the target host,
especially if the target host has a different version of the operating system.
This is extremely important for SunOS or Solaris,
where
there tend to be changes in the system's include files between
versions
as well as support libraries.
<P>Read the notes for your OS in section
<A HREF="LPRng-HOWTO-5.html#sysdep">System-dependent notes</A>
for specific installation help (if any).
<H2><A NAME="disablelocalhost"></A> <A NAME="ss4.5">4.5 Advanced Configuration Options</A>
</H2>

<P>While the default LPRng configuration will be suitable for most
individual users,
administrators of large sites or which need to support 
<I>lightweight print clients</I>
will need to use the following configure options.
<OL>
<LI><CODE>--disable-force_localhost</CODE><BR>
The default LPRng configuration assumes that all printing will be done
via a <CODE>lpd</CODE> print spooler running on the local host system.
However,
many larger sites prefer that all users do their printing via a
few central servers,
and do not run
<CODE>lpd</CODE> servers on user systems.
The
<CODE>--disable-force_localhost</CODE>
configuration will simply this type of operation by eliminating the need for a
<CODE>/etc/lpd.conf</CODE> file to override the <CODE>force_localhost</CODE> option.</LI>
<LI><CODE>--disable-setuid</CODE>
This option will install the LPRng executables without SETUID permissions.
Non-setuid clients and programs are inherently more secure than SETUID programs,
and system administrators would be well advised to install them without
SETUID root permissions.
Please see 
<A HREF="#setuid">Advanced Security Considerations</A>
for more details about this option.</LI>
<LI><CODE>--enable-priv_ports</CODE>
This option will install a default
<CODE>lpd.perms</CODE> file which disallows connections from non-privileged ports.
In effect,
this will require that on UNIX systems the originating user be root or
the program be SETUID root.
By default,
LPRng will allow connections from any port.
Please see 
<A HREF="#setuid">Advanced Security Considerations</A>
for more details about this option.</LI>
<LI><CODE>--disable-require_configfiles</CODE>
By default, the
<CODE>lpr</CODE>,
<CODE>lpq</CODE>,
<CODE>lpc</CODE>, ...
clients will required a <CODE>lpd.conf</CODE> file and the <CODE>printcap</CODE>
to be present.
The
<CODE>--disable-require_configfiles</CODE>
option relaxes this requirement,
and if the files are missing,
will not complain.</LI>
</OL>
<H2><A NAME="requireconfig"></A> <A NAME="ss4.6">4.6 Printcap and lpd.conf files</A>
</H2>

<P>The <CODE>printcap</CODE> file contains the definitions of print queues
and other information used by LPRng.
The exact location of the file is determined by the
<CODE>configure</CODE> options and defaults for your system.
The default used by <CODE>configure</CODE> is <CODE>/usr/local/etc/printcap</CODE>,
but it is more commonly found in <CODE>/etc/printcap</CODE>.
If your system does not have an <CODE>printcap</CODE> file,
then the following is suitable for initial testing and configuration:
<BLOCKQUOTE><CODE>
<PRE>
# test printcap file
lp:cm=Test Printcap Entry:
 :lp=/dev/null
 :sd=/usr/spool/lpd/lp
</PRE>
</CODE></BLOCKQUOTE>
<P>The <CODE>lpd.conf</CODE>
(default location is <CODE>/usr/local/etc/lpd.conf</CODE>)
file contains settings that override the defaults provided at compile time.
You will find a prototype or template <CODE>lpd.conf</CODE> file in the LPRng distribution.
If you do not have an existing <CODE>lpd.conf</CODE> file,
the default one will be installed.
You can install this by hand using:
<BLOCKQUOTE><CODE>
<PRE>
astart > cd LPRng/src
astart > su
ASTART # cp lpd.conf /usr/local/etc/lpd.conf
ASTART # chmod 644 /usr/local/etc/lpd.conf
</PRE>
</CODE></BLOCKQUOTE>
<P>The various client programs such as
<CODE>lpr</CODE>,
<CODE>lpq</CODE>,
etc. will check for a <CODE>lpd.conf</CODE> and <CODE>printcap</CODE>
file.
You can relax this requirement by setting
the
<CODE>require_configfile</CODE> option false
(<CODE>require_configfile@</CODE>)
by using the configuration option <CODE>--disable-require_configfile</CODE>,
by setting the <CODE>require_configfile</CODE> option in the
<CODE>lpd.conf</CODE> file,
or building the
executables with <CODE>make REQUIRE_CONFIGILE="1"</CODE>.
<H2><A NAME="user"></A> <A NAME="group"></A> <A NAME="ss4.7">4.7 Security, Permissions, and CHECKPC</A>
</H2>

<P>By default,
the <CODE>lpd</CODE> server is run as a ROOT (user 0)
process.
(This is true not only for LPRng,  but also for all
other system processes which are started at boot time.)
However,
normally LPRng will do operations as a non-privileged user and group
which is defined by the value of the
<CODE>user</CODE> (default <CODE>daemon</CODE>) and
<CODE>group</CODE> (default <CODE>daemon</CODE>) option
in the <CODE>/etc/lpd.conf</CODE> configuration file
or the compile time defaults in the
<CODE>LPRng/src/vars.c</CODE> file.
<P>The following steps must be taken in order to preserve
system security:
<OL>
<LI>Create a user and group <CODE>daemon</CODE> on the system.
This user does not need login privileges,
but will need a home directory if secure authentication
such as Kerberos or PGP will be done.</LI>
<LI>The <CODE>lpd.conf</CODE>
file should be owned by root (user 0),
and should have read-only (0444) permissions.</LI>
<LI>The <CODE>printcap</CODE>
file should be owned by root (user 0),
and should have read-only (0444) permissions.</LI>
<LI>The spool and working directories used by LPRng should be
owned by user <CODE>daemon</CODE>,  group <CODE>daemon</CODE>,
and have 0700 permissions (accessible only by user <CODE>daemon</CODE>).</LI>
</OL>
<H3>Using CHECKPC</H3>

<P>The
<CODE>checkpc</CODE>
program is used to make sure that
the spool directories and files used by LPRng have the correct permissions
and are in place.
By default,
<CODE>checkpc</CODE> will check permissions and report if there are any problems.
You should run this as <CODE>root</CODE>.
For example:
<BLOCKQUOTE><CODE>
<PRE>
% astart > su
#>cd LPRng/src
#>./checkpc
Warning - No configuration file '/usr/local/etc/lpd.conf'
Warning - No lpd only printcap file found in '/usr/local/lpd_printcap'
Warning -  ** cannot open '/var/run/lpd.printer' - 'Permission denied'
Warning -  bad directory - /var/spool/lpd/lp
Warning -   Printer_DYN 'lp' spool dir '/var/spool/lpd/lp' needs fixing
</PRE>
</CODE></BLOCKQUOTE>
<P>In the above example,
<CODE>checkpc</CODE> has discovered that the <CODE>lpd.conf</CODE>
file is missing.
This is not a serious problem if the system defaults are to be used,
but you might want to put the default <CODE>LPRng/lpd.conf</CODE> file from the
distribution in place.
<P>The <I>lpd only printcap</I>
message is usually of concern to administrators who wish to use some of
LPRng's more exotic configuration options.
It is possible to have separate printcap databases for client and server programs.
This is useful when printcap files get extremely large and cuts down
substantially on system management problems.
<P>The permission denied message for <CODE>/var/run/lpd.printer</CODE> is more serious,
as the <CODE>lpd</CODE> server uses this as a lock file.
<P>The <I>bad directory</I> message about the spool directory is usually caused by
bad permissions or when the directory is missing.
<P>The <CODE>checkpc -f</CODE> option causes <CODE>checkpc</CODE> to take action to rectify errors.
You can see what is happening if you run it with the <CODE>-V</CODE> (verbose) option:
<BLOCKQUOTE><CODE>
<PRE>
% astart > su
#>cd LPRng/src
# ./checkpc -f -V
LPRng version LPRng-3.6.1
 DaemonUID 1, DaemonGID 12
Using Config file '/usr/local/etc/lpd.conf'
Checking for configuration files '/usr/local/etc/lpd.conf'
Warning - No configuration file found in '/usr/local/etc/lpd.conf'
Checking for printcap files '/usr/local/etc/printcap'
  found '/usr/local/etc/printcap', mod 0100644
Checking for lpd only printcap files
     '/usr/local/etc/lpd_printcap'
Warning - No lpd only printcap file found in
     '/usr/local/etc/lpd_printcap'
LPD lockfile '/var/run/lpd.printer'
  checking '/var/run/lpd.printer' file
Names
 :lp=lp
All
 :lp
Printcap Information
lp
 :force_localhost
 :lp=lw4@astart4.astart.com
 :sd=/var/spool/lpd/lp
Checking printcap info
Checking printer 'lp'
 Checking directory: '/var/spool/lpd/lp'
  file 'control.lp', size 0 K, unchanged in 2 hours
  file 'status.lp', size 0 K, unchanged in 2 hours
  file 'status', size 0 K, unchanged in 2 hours
  file 'log', size 0 K, unchanged in 2 hours
  checking 'control.lp' file
  checking 'status.lp' file
  checking 'status' file
  cleaning 'status' file, 0 bytes long: no truncation
  checking 'log' file
  cleaning 'log' file, 0 bytes long: no truncation
</PRE>
</CODE></BLOCKQUOTE>
<P>As you can see, <CODE>checkpc</CODE> can not only print detailed information about your
printing system,  but it also fixes up the various problems.
<H3><A NAME="setuid"></A> Advanced Security Concerns</H3>

<P>While <CODE>checkpc</CODE> will set permissions,
there is always the problem with undetected errors in the LPRng
software that,
when exploited,
could cause severe system problems.
The most serious concern is that of gaining root (user 0) permissions.
<P>One way to avoid this is to run
<I>client</I>
programs without root permission.
This operation is possible for LPRng
in contrast to other print spooling software.
<P>A serious problem running LPRng as a nonprivileged
user (root) is the fact that the RFC protocol specifies
that connections are made to port 515
and
<CODE>lpd</CODE>
requires root permissions to open and bind to port 515.
One option is to have the <CODE>lpd</CODE> server drop root permissions
soon after binding to this port and before accepting any user
commands.
However,
in order to fully compatible with RFC1179,
<CODE>lpd</CODE> must originate connections from a <I>reserved</I>
port in the range 721-731,
although in practice port 1-1023 seems to be acceptable.
<P>If inter-operability with non-LPRng print spoolers is not desired,
then it is <I>trivial</I>
to configure LPRng using the <CODE>lpd.conf</CODE>
file or by modifying the compile time
<CODE>lpd_port</CODE>
value in the file or the <CODE>LPRng/src/vars.c</CODE>
so that all the software will run
as client programs.
For example,
in the <CODE>/etc/lpd.conf</CODE> file,
you only need to change the indicated lines:
<BLOCKQUOTE><CODE>
<PRE>
# Purpose: lpd port
#   default lpd_port=printer
lpd_port=2000
</PRE>
</CODE></BLOCKQUOTE>
<P>Now all the LPRng software will use port 2000 to transfer jobs and
commands.
You can also use this facility to establish a
<I>private</I> set of print spoolers which can be used for testing.
<H2><A NAME="ss4.8">4.8 Stopping Existing Spooler Software</A>
</H2>

<P>The next step is to shut down and remove the existing print
spooler,
and test the functionality of the LPRng <CODE>lpd</CODE>
programs.
Unfortunately,
this process is fairly system dependent,
and requires a small amount of system expertise.
In addition to these general directions,
you should see the 
<A HREF="LPRng-HOWTO-5.html#sysdep">System specific notes</A> for your system.
<H3>SunOS and BSD Derived</H3>

<P>This section provides instructions for  systems that use the
<CODE>lpd</CODE> print services,
such as SunOS,
BSD derived systems,
and Linux based systems.
These systems use an <CODE>lpd</CODE> print server,
as does LPRng.
<P>We first kill the currently running <CODE>lpd</CODE> process.
While there may be a system shutdown script
in the <CODE>/etc/rc.d/</CODE> directory or other location for this,
do not bother using it.
<BLOCKQUOTE><CODE>
<PRE>
# most BSD Systems
ps -auxw |grep lpd
# Kill it twice
kill (pid of lpd server)
#  This should report an error - if not then lpd did not terminate
kill (pid of lpd server)
#

Example:
astart % ps -axuw |grep lpd
papowell 23932  0.0  0.3  224  184  p3  S+  10:40AM  0:00.01 grep lpd
daemon  17763  0.0  0.2  448  120  ??  IWs  29Mar99  0:01.35 (lpd)
astart % kill 135
astart % kill 135
135: No such process
</PRE>
</CODE></BLOCKQUOTE>
<P>Next,
you should remove or rename the existing print system executables.
The following example shows how to use the
<CODE>find</CODE> utility to track down candidates.
<BLOCKQUOTE><CODE>
<PRE>
astart# find /usr -type f -name lp\*  -print >/tmp/candidates
astart# find /sbin -type f -name lp\*  -print >>/tmp/candidates
astart# cat /tmp/candidates
/usr/bin/lpunlock
/usr/bin/lpqall.faces
/usr/bin/lpq             &lt;---- old
/usr/bin/lpr             &lt;---- old
/usr/bin/lprm            &lt;---- old
/usr/bin/lptest
/usr/doc/samba-1.9.18p10/examples/printer-accounting/lp-acct
/usr/man/man1/lpq.1
/usr/man/man1/lpr.1
/usr/man/man1/lprm.1
/usr/man/man1/lptest.1
/usr/man/man4/lp.4
/usr/man/man8/lpc.8
/usr/man/man8/lpd.8
/usr/sbin/lpc            &lt;--- old
/usr/sbin/lpd            &lt;--- old
/usr/sbin/lpf            &lt;--- old
/usr/local/bin/lpc    &lt;-- LPRng
/usr/local/bin/lpq    &lt;-- LPRng
/usr/local/bin/lpr    &lt;-- LPRng
/usr/local/bin/lprm   &lt;-- LPRng
/usr/local/sbin/lpd   &lt;-- LPRng
astart # mv /usr/bin/lpq  /usr/bin/lpq.old
astart # mv /usr/bin/lpr  /usr/bin/lpr.old
astart # mv /usr/bin/lprm /usr/bin/lprm.old
astart # mv /usr/sbin/lpc /usr/sbin/lpc.old
astart # mv /usr/sbin/lpd /usr/sbin/lpd.old
astart # mv /usr/sbin/lpf /usr/sbin/lpf.old
...
</PRE>
</CODE></BLOCKQUOTE>
<H3>Solaris, HP, AIX, and SysVR4 Derived Systems</H3>

<P>The original SysVR4 and other related systems did not have
any support for RFC1179 network printing (Berkeley LPD).
Support for this was added by various manufacture specific methods.
Unfortunately,
there are a wide range of possibilities.
<P>The <CODE>lpsched</CODE> process (<CODE>/usr/lib/lp/lpsched/</CODE>)
process performs many of the functions of the LPRng and BSD
<CODE>lpd</CODE>
server.
On Solaris systems,
it also stats the
<CODE>lpNet</CODE>
server that provides network print services.
Unfortunately,
no <I>simple</I> and reliable method of shutting down a running <CODE>lpsched</CODE>
process
and the associated network services has been found.
However,
it turns out to be very simple to <EM>prevent</EM> the services from
being started.
<P>First,
you will need to locate the <CODE>/etc/rc</CODE> startup files
that start system services.
During system startup,
a set of shell scripts stored in the <CODE>/etc/rc.d</CODE>
directories are executed.
The individual startupfile files are usually links to a
common one in the <CODE>/etc/init.d</CODE> directory.
You first need to find the files containing the startup commands.
This is done as shown below:
<BLOCKQUOTE><CODE>
<PRE>
SUN # cd /
SUN # grep -l lpsched /etc/rc* /etc/rc*/* init.d/* init.d/*/* >/tmp/files
SUN # cat /tmp/files
/etc/rc0.d/K20lp
/etc/rc2.d/K20lp
/etc/rc2.d/S80lp
/etc/init.d/lp
># ls -l ` cat /tmp/files `
lrwxrwxr-x 1 root bin 1 Dec 29 23:39 /etc/rc0.d/K20lp -> ../../init.d/lp
lrwxrwxr-x 1 root bin 1 Dec 29 23:39 /etc/rc2.d/K20lp -> ../../init.d/lp
lrwxrwxr-x 1 root bin 1 Dec 29 23:39 /etc/rc2.d/S80lp -> ../../init.d/lp
-rwxr--r-- 5 root sys 460 Sep 1 1998 /etc/rcS.d/K39lp
</PRE>
</CODE></BLOCKQUOTE>
<P>Here is the contents of the typical script file,  with the
indicated modifications that should be made for testing
<BLOCKQUOTE><CODE>
<PRE>
#!/sbin/sh

#### ADD THE FOLLOWING LINE TO EXIT EARLY
exit 0
#### THE REST IS THE USUAL SCRIPT
case "$1" in
'start')
    [ -f /usr/lib/lpsched ] &amp;&amp; /usr/lib/lpsched ;;
'stop' )
    [ -f /usr/lib/lpshut ] &amp;&amp; /usr/lib/lpshut ;;
*) 
    echo "Usage: $0 { start | stop }"
    exit 1
esac
exit 0
</PRE>
</CODE></BLOCKQUOTE>
<P>Next,
as for the BSD installation,
we will find all of the printing related commands and rename them.
You can either rename them one by one,
or use the script method shown below.
The minimum of the indicated files should be renamed.
<BLOCKQUOTE><CODE>
<PRE>
SUN # find /usr -type f -name lp\* -print >/etc/printingfiles
SUN # cat /tmp/printingfiles
/usr/bin/lp          &lt;---
/usr/bin/lpstat      &lt;---
/usr/lib/lp/bin/lp.cat
/usr/lib/lp/bin/lp.set
/usr/lib/lp/bin/lp.tell
/usr/lib/lp/lpNet    &lt;---
/usr/lib/lp/lpsched  &lt;---
/usr/lib/lp/lpdata   &lt;---
/usr/sbin/lpadmin    &lt;---
/usr/sbin/lpfilter   &lt;---
/usr/sbin/lpforms    &lt;---
/usr/sbin/lpmove     &lt;---
/usr/sbin/lpshut     &lt;---
/usr/sbin/lpsystem   &lt;---
/usr/sbin/lpusers    &lt;---
/usr/ucb/lpc         &lt;---
/usr/ucb/lpq         &lt;--- 
/usr/ucb/lpr         &lt;---
/usr/ucb/lprm        &lt;---
/usr/ucb/lptest
SUN # for i in ` cat /tmp/printingfiles ` ; do
>  mv $i $i.old
>  done
</PRE>
</CODE></BLOCKQUOTE>
<P>Next, you find if there is a <I>cron</I> job scheduled
by the file
<CODE>/var/spool/cron/crontabs/lp</CODE>
to periodically update and roll over error logs.  
If there is, you should
(after having saved the file)
remove it.
<BLOCKQUOTE><CODE>
<PRE>
cp /var/spool/cron/crontabs/lp /etc/cron.crontabs.lp
</PRE>
</CODE></BLOCKQUOTE>
<P>Check the <CODE>/etc/inetd.conf</CODE> file for a line like:
<BLOCKQUOTE><CODE>
<PRE>
printer stream tcp nowait root /usr/lib/print/in.lpd in.lpd
</PRE>
</CODE></BLOCKQUOTE>
<P>Comment out this line.
This line is not present on all systems.
<P>Now we must <EM>reboot</EM>  the machine.  You can use
<CODE>reboot</CODE> if you are in a rush,
and <CODE>shutdown</CODE> if you are not.
<BLOCKQUOTE><CODE>
<PRE>
SUN # reboot
or
SUN # shutdown -y "Whooga! Whooga! Dive! Dive! System going down."
</PRE>
</CODE></BLOCKQUOTE>
<P>When the system reboots,
check to make sure that the
<CODE>lpd</CODE> server is not listening on port 515.
<BLOCKQUOTE><CODE>
<PRE>
SUN # telnet localhost 515
Trying 127.0.0.1...
telnet: Unable to connect to remote host: Connection refused
</PRE>
</CODE></BLOCKQUOTE>
<P>If you do get a connection established
then you must use <CODE>nlsadmin</CODE> to force the
<I>tcpip listener</I> to release the port, as illustrated below.
<BLOCKQUOTE><CODE>
<PRE>
SUN # nlsadmin -v tcp
lpd  \x00020203000000000000000000000000  ENABLED  \
  NORPC  root  NOMODULES  /var/spool/lp/fifos/listenBSD  #
0  \x00020ACE000000000000000000000000  ENABLED    \
  NORPC  root  NOMODULES  /usr/lib/saf/nlps_server  #
lp  NOADDR  ENABLED  NORPC  root  NOMODULES \
  /var/spool/lp/fifos/listenS5  #
SUN # nlsadmin -r lpd tcp
SUN # nlsadmin -r lp tcp
</PRE>
</CODE></BLOCKQUOTE>
<P>Once you disable this,
you should try to reconnect to port 515.  If you still cannot,
then you have a problem  and need to reboot once more.
<P>You might also want to run
<CODE>pmadm -l</CODE> and if you see anything other than zsmon stuff (e.g. lp
stuff is there), then use <CODE>pmadm -r </CODE>to remove it.
See the man page for details.
<H2><A NAME="ss4.9">4.9 Initial System Testing</A>
</H2>

<P>We will now run the <CODE>lpd</CODE> executable in the
<CODE>foreground</CODE> and <CODE>test</CODE> mode,
and make sure that our system configuration is
correct.
It is best to do this with two screens or windows,
as you will want to observe the output.
<BLOCKQUOTE><CODE>
<PRE>
# > /usr/local/bin/lpd -F
Fatal error - Another print spooler is using TCP printer port
# > /usr/local/bin/lpd -F -D1
...
1999-04-05-10:02:37.755 astart10 [28903] lpd  Read_file_and_split: \
  cannot open file '/etc/lpd.perms' - No such file or directory
1999-04-05-10:02:37.758 astart10 [28903] lpd  Read_file_and_split: \
  cannot open file '/usr/etc/lpd.perms' - No such file or directory
1999-04-05-10:02:37.759 astart10 [28903] lpd  Build_printcap_info: \
  list->count 0, raw->count 3
1999-04-05-10:02:37.777 astart10 [28903] lpd  lpd: listening socket fd -6
Fatal error - Another print spooler is using TCP printer port
1999-04-05-10:02:37.782 astart10 [28903] lpd  Get_max_fd: getrlimit returns 64
1999-04-05-10:02:37.783 astart10 [28903] lpd  Get_max_fd: returning 64
1999-04-05-10:02:37.786 astart10 [28903] lpd  cleanup: done, doing killpg \
   then exit(0)
</PRE>
</CODE></BLOCKQUOTE>
<P>If you get the above error message,
then you have either not killed off other the running <CODE>lpd</CODE> server
or you are not starting the <CODE>lpd</CODE> server as ROOT.
This is the most common error during setup.
Correct the problem and then restart the server if necessary.
You should see the output indicated below:
<BLOCKQUOTE><CODE>
<PRE>
# > /usr/local/bin/lpd -F -D1
1999-04-05-14:35:14.023 astart27 [2667] Waiting  lpd: LOOP START
1999-04-05-14:35:14.024 astart27 [2667] Waiting  Get_max_servers: getrlimit returns 256
1999-04-05-14:35:14.024 astart27 [2667] Waiting  Get_max_servers: returning 128
1999-04-05-14:35:14.025 astart27 [2667] Waiting  lpd: max_servers 128, active 0
1999-04-05-14:35:14.025 astart27 [2667] Waiting  lpd: starting select timeout 'yes', 600 sec
</PRE>
</CODE></BLOCKQUOTE>
<P>Now from another window do the following commands:
<BLOCKQUOTE><CODE>
<PRE>
# > lpq -Plp@localhost
Printer: lp@astart 
 Queue: no printable jobs in queue
# > lpq
Printer: lp@astart 
 Queue: no printable jobs in queue
</PRE>
</CODE></BLOCKQUOTE>
<P>At this point your LPRng software has been installed and tested.
You still need to set up
<I>Startup Scripts</I>
to automatically start it at boot time,
and
<CODE>/etc/printcap</CODE>
entries for your printers.
<H2><A NAME="startup"></A> <A NAME="ss4.10">4.10 Startup Scripts</A>
</H2>

<P>The purpose of startup scripts is to automatically start the <CODE>lpd</CODE>
print server at boot time.
Again,
the location and contents of these depend strongly on the
version of the Operating System, and system vendor.
<H3>SunOS and BSD Derived</H3>

<P>In most of these systems the startup script
for
<CODE>lpd</CODE>
is already present in the
<CODE>/etc/rc</CODE> files
and only has to be modified.
It can be found by using:
<BLOCKQUOTE><CODE>
<PRE>
ASTART # grep -l lp /etc/rc* /etc/rc*/* /etc/rc*/*/*
/etc/rc
ASTART # more /etc/rc
...
if [ -f /etc/printcap ]; then
    echo -n ' printer';     /usr/sbin/lpd
fi
</PRE>
</CODE></BLOCKQUOTE>
<P> Modify this file so that path is to the LPRng <CODE>lpd</CODE> file.
<H3>Solaris,  Linux, and SysVR4</H3>

<P>These systems have individual startup files for each printing service.
We need to update the startup files to reference the LPRng executables.
<BLOCKQUOTE><CODE>
<PRE>
SUN # grep -l lp /etc/rc* /etc/rc*/* init.d/* init.d/*/* >/tmp/files
SUN # cat /tmp/files
/etc/rc0.d/K20lp
/etc/rc2.d/K20lp
/etc/rc2.d/S80lp
/etc/init.d/lp
># ls -l ` cat /tmp/files `
lrwxrwxr-x  1 root  bin  1 Dec 29 23:39 /etc/rc0.d/K20lp -> ../../init.d/lp
lrwxrwxr-x  1 root  bin  1 Dec 29 23:39 /etc/rc2.d/K20lp -> ../../init.d/lp
lrwxrwxr-x  1 root  bin  1 Dec 29 23:39 /etc/rc2.d/S80lp -> ../../init.d/lp
-rwxr--r--  5 root  sys  460 Sep 1 1998 /etc/rcS.d/K39lp
</PRE>
</CODE></BLOCKQUOTE>
<P>Modify the startup files so that they use the LPRng <CODE>lpd</CODE> executable:
<BLOCKQUOTE><CODE>
<PRE>
#!/sbin/sh
case "$1" in
'start')
        [ -f /usr/local/bin/lpd ] &amp;&amp; /usr/local/bin/lpd
        ;;
'stop')
    echo "Shutting down lpd: \c"
    kill -2 `cat /var/run/lpd*` >/dev/null 2>1;
        ;;

*)
        echo "Usage: $0 { start | stop }"
        exit 1
esac
exit 0
</PRE>
</CODE></BLOCKQUOTE>
<H2><A NAME="lpsimulation"></A> <A NAME="ss4.11">4.11 Replacing UNIX SystemV lp, lpstat Printing Services</A>
</H2>

<P>Many UNIX utilities in the Solaris and HP UNIX environment use the
UNIX System V <CODE>lp</CODE> and <CODE>lpstat</CODE>
programs.
It is almost impossible to modify the programs themselves,
as many are <EM>vintage</EM> software that is unsupported or which would
be too costly to update.
<P>In order to support these applications,
LPRng provides simulation for the
<CODE>lp</CODE>,
<CODE>lpstat</CODE>,
and
<CODE>clean</CODE>
commands.
<P>The LPRng <CODE>lpstat</CODE> command is a modified version of the
<CODE>lpq</CODE> command,
and accepts the <CODE>lpstat</CODE> command line options and tries to return
status in an <CODE>lpstat</CODE> format.
<P>If the <CODE>lpr</CODE> program is invoked with the name <CODE>lp</CODE>,
it will simulate the <CODE>lp</CODE>options.
Finally, if the <CODE>lprm</CODE> program is invoked with the name <CODE>cancel</CODE>,
it will simulate the <CODE>lp</CODE>options.
This can be done by using symbolic links or copying the programs.
<P>Note that many of the <CODE>vintage</CODE> applications have fully qualified
paths to the <CODE>lp</CODE> and <CODE>lpstat</CODE> executables,
so it will be necessary to copy them to the original program locations.
<BLOCKQUOTE><CODE>
<PRE>
# original - /usr/bin/lp
# original - /usr/bin/lpstat
cd /usr/local/bin
cp lpr /usr/bin/lp
cp lpstat /usr/bin/lpstat
cp lprm /usr/bin/cancel
</PRE>
</CODE></BLOCKQUOTE>
<P>See the man pages for lp, lpstat, and cancel in the LPRng/man directory.
Not all the functions of the original
programs are supported and
these man pages should be installed to replace the original
lp, etc, man pages.
<HR>
<A HREF="LPRng-HOWTO-5.html">Next</A>
<A HREF="LPRng-HOWTO-3.html">Previous</A>
<A HREF="LPRng-HOWTO.html#toc4">Contents</A>
</BODY>
</HTML>
