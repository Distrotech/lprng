<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
<TITLE> LPRng-HOWTO: Filters</TITLE>
</HEAD>
<BODY>
<A HREF="LPRng-HOWTO-7.html">Next</A>
<A HREF="LPRng-HOWTO-5.html">Previous</A>
<A HREF="LPRng-HOWTO.html#toc6">Contents</A>
<HR>
<H2><A NAME="s6">6. Filters</A></H2>

<P>This section gives an overview of how LPRng uses filter programs,
and gives a detailed discussion of how the printcap options and
filters interact.
<H2><A NAME="ss6.1">6.1 What are filters?</A>
</H2>

<P>Print filters are one of the most powerful tools in BSD-style printer
systems.
<P>In general UNIX terms, a <EM>filter</EM> is a program that takes its input
file(s), does something with it, and sends the result to its standard
output. Most UNIX utilities are designed as filters.
(But since you are a system manager, you should already know that :))
<P>In the context of a BSD-style print spooler (and also LPRng), the term
<EM>filter</EM> refers to a program that does processing on a file that is
submitted to the printer. As such, it is a specific example of the
general class of programs called `filters'.
<P>Usually the
filter is executed with STDIN reading from the file to be
printed
or program generating the output and STDOUT to the printer device.
STDERR (file handle 2) is redirected to a log file,
and file handle&nbsp;3 to an accounting file.
<P>A filter can be as simple as a <CODE>LF</CODE> to <CODE>CR/LF</CODE>
translator (the example used before),
or it can incorporate a complete
accounting system, automatic file type translations,
or even redirect the job to another printing system.
<P>As part of the LPRng project,
the following filters are supported.
See the associated documentation for details.
<UL>
<LI> Distributed in the LPRng source distribution<BR>
<A HREF="#lpf">lpf</A>
a very simple CR/LF or passthrough filter.</LI>
<LI> Distributed in the FILTERS_LPRng distribution:<BR>
<A HREF="#ifhp">CTI-ifhp</A>
HP PCL and PJL printer filters </LI>
<LI>
<A HREF="#psfilter">psfilter</A>
PostScript printer filter</LI>
</UL>

The supported filters and other facilities are available from
<A HREF="ftp://ftp.astart.com/pub/LPRng">ftp://ftp.astart.com/pub/LPRng</A>
<A NAME="if"></A> <H2><A NAME="ss6.2">6.2 What are print formats?</A>
</H2>

<P>Options used:
<UL>
<LI><CODE>if</CODE>,
<CODE>cf</CODE>,
<CODE>df</CODE>,
<CODE>gf</CODE>,
<CODE>nf</CODE>,
<CODE>of</CODE>,
<CODE>rf</CODE>,
<CODE>tf</CODE>,
<CODE>vf</CODE>,
<EM>X</EM><CODE>f</CODE>,
<EM>&nbsp;&nbsp;Filter programs </EM></LI>
</UL>
<P>LPRng has inherited a set of so-called `<B>print formats</B>' from its
BSD ancestor.
The format was originally used
to specify the type of file that was being printed.  The
<CODE>lpd</CODE> daemon
would use the print format to select the required
filter for processing the file.
<B>The default format is <CODE>f</CODE></B>.
<P>The user can specify the format (i.e., the file type) by giving
the appropriate option to <CODE>lpr</CODE>:
<P>
<UL>
<LI><CODE>-b</CODE> or <CODE>-l</CODE>: Binary (literal) file. No processing should
be done.
The
<CODE>l</CODE> format is recorded as the file format.</LI>
<LI><CODE>-c</CODE>: cifplot(1) output.</LI>
<LI><CODE>-d</CODE>: TeX DVI file.</LI>
<LI><CODE>-g</CODE>: Output from the plot(3X) routines.</LI>
<LI><CODE>-n</CODE> or <CODE>-t</CODE>: (di)troff output.</LI>
<LI><CODE>-p</CODE>: Text file that should be pre-processed by the <CODE>pr</CODE>
command, and then by the standard text filter.</LI>
<LI><CODE>-r</CODE>: Text with FORTRAN carriage control characters in the
first column. (Used to be the <CODE>-f</CODE> option.)</LI>
<LI><CODE>-v</CODE>: Benson Varian raster image.</LI>
</UL>
<P>Alternatively, one can also use
<CODE>-Fx</CODE>, where <CODE>x</CODE> is the format specifier.
(E.g., <CODE>-Fc</CODE>
instead of <CODE>-c</CODE>.)
This last form also allows you to use other
(non-standard) format specifiers.
<P>The filter for format
<CODE>X</CODE>
is the value for the
<CODE>Xf</CODE> printcap
option,
with some minor exceptions.
The following
<CODE>Xf</CODE>
options have a pre-defined meaning.
<P>
<UL>
<LI><CODE>if</CODE>
The <CODE>f</CODE>
format filter,
i.e. - for the default
<CODE>f</CODE>
format.
All print jobs are passed
through this one, unless another format is selected.</LI>
<LI>
<A NAME="cf"></A> 
<CODE>cf</CODE> Cifplot data filter (for <CODE>-c</CODE> format).</LI>
<LI>
<A NAME="df"></A> 
<CODE>df</CODE> Filter for DVI files (<CODE>-d</CODE>).</LI>
<LI>
<A NAME="gf"></A> 
<CODE>gf</CODE> Graph data filter (<CODE>-g</CODE>).</LI>
<LI>
<A NAME="nf"></A> 
<CODE>nf</CODE> Ditroff data filter (<CODE>-n</CODE>).</LI>
<LI><CODE>of</CODE> This filter is used for processing the (optional)
banner at the start and/or end of the print job,
and also for the interjob separators.
See
<A HREF="#ofdetails">of</A> filter for details.</LI>
<LI>
<A NAME="rf"></A> 
<CODE>rf</CODE> Filter for Fortran style files (<CODE>-r</CODE>).</LI>
<LI>
<A NAME="tf"></A> 
<CODE>tf</CODE> Troff filter (<CODE>-t</CODE>).</LI>
<LI>
<A NAME="vf"></A> 
<CODE>vf</CODE> (Versatek) raster image filter (<CODE>-v</CODE>).</LI>
</UL>

<A NAME="ofdetails"></A> <H2><A NAME="ss6.3">6.3 OF Filter</A>
</H2>

<P>The
<CODE>of</CODE>
filter is used to process banners and job separators.
The
<CODE>of</CODE> filter is responsible for performing appropriate
processing of this information and sending to the printer
for action.
<P>While the various file filters are invoked on a once per print file basis,
the
<CODE>of</CODE>
filter is invoked on a once per print job basis.
<P>This filter is the first one to be started,
and should perform whatever specialized device initialization
is needed.
It should also do whatever accounting procedure is desired
for start of job accounting.
<P>The
<CODE>of</CODE>
filter will be given any banner printing or job separation
information for a job.
As part of its operation,
it can detect a specific string,
corresponding to a banner print request,
and generate a banner.
(See the
<A HREF="#jobsteps">Job Processing Steps and Printcap Options</A>
for details.)
<P>During operation,
the
<CODE>lpd</CODE> server will send the special
<B>stop</B> sequence of <CODE>\031\001</CODE> to the
<CODE>of</CODE> filter.
The filter must then suspend itself using a
<CODE>kill -STOP</CODE> operation.
The <CODE>lpd</CODE> server will detect that the
<CODE>of</CODE> filter has suspended itself and then
will perform other printing operations.
<P>After the other printing operations have been completed,
the <CODE>of</CODE> will then be sent a
<CODE>kill -CONT</CODE> signal.
<P>This sequence will continue until all information has been printed,
and then the <CODE>of</CODE> filter's STDIN will be closed.
The filter will then perform whatever cleanup operations are needed,
update accounting or other information,
and exit.
<A NAME="pr"></A> <H2><A NAME="ss6.4">6.4 The lpr -p  format and pr option</A>
</H2>

<P>Options used:
<UL>
<LI><CODE>pr=</CODE><EM>pr program for p format</EM></LI>
</UL>
<P>The <CODE>-p</CODE> format is implemented by sending the file through
the program
specified by the <CODE>pr</CODE>
printcap utility (default is <CODE>/bin/pr</CODE>),
and passing the result to the normal
<CODE>:if</CODE> filter.
<H2><A NAME="ss6.5">6.5 The lpr -l  format and binary format</A>
</H2>

<P>The binary (or literal) format
is indicated by format type
<CODE>-l</CODE>.
The <CODE>if</CODE> filter
is used to process the file,
and is invoked with the
<CODE>-c</CODE>
(<CODE>c</CODE>ancel processing?) flag.
<A NAME="jobsteps"></A> <H2><A NAME="ss6.6">6.6 Job Processing and Printcap Options</A>
</H2>

<P>Much of the flexibility of the LPRng software is obtained
from the ability to control the details of each step of job processing.
The following section details each step in the processing of a job,
and explains the printcap options used to control each operation.
<P>Assume the <CODE>pr</CODE>
printcap entry has the form:
<PRE>
pr
    :lp=/dev/lp  OR  :lp=rp@rm
    :sd=/var/spool/lpd/pr
    :lf=log
    :of=/usr/local/bin/lpf
    :if=/usr/local/bin/lpf
</PRE>
<P>Assume that we have used the following command to print
a set of files.
<PRE>
lpr -Ppr file1 file2
</PRE>
<P>This will create a control file
in the
<CODE>/var/spool/lpd/pr</CODE>
directory with the following contents (this is an example -
in practice there may be minor differences between the example
and an actual control file):
<PRE>
Hastart4.astart.com
J/tmp/file1 /tmp/file2
CA
Lpapowell
Ppapowell
fdfA002230astart4.astart.com
N/tmp/file1
UdfA002230astart4.astart.com
fdfB002230astart4.astart.com
N/tmp/file2
UdfB002230astart4.astart.com
</PRE>
<P>
<A NAME="achk"></A> 
<A NAME="af"></A> 
<A NAME="as"></A> 
<A NAME="ff"></A> 
<A NAME="fo"></A> 
<A NAME="lk"></A> 
<A NAME="lpdev"></A> 
<A NAME="la"></A> 
<A NAME="ar"></A> 
<A NAME="ld"></A> 
<A NAME="rw"></A> 
<A NAME="connectgrace"></A> 
<A NAME="networkconnectgrace"></A> 
<A NAME="connectinterval"></A> 
<A NAME="connecttimeout"></A> 
<A NAME="connecttry"></A> 
<A NAME="controlfilter"></A> 
<A NAME="nb"></A> 
<A NAME="servertmpdir"></A> <H3>Opening the Output Device</H3>

<P>Options used:
<UL>
<LI> <CODE>achk</CODE><EM>&nbsp;&nbsp;Accounting check at start</EM></LI>
<LI> <CODE>af=</CODE><EM>Accounting File</EM></LI>
<LI> <CODE>ar</CODE><EM>&nbsp;&nbsp;Remote printer accounting enabled</EM></LI>
<LI> <CODE>as=</CODE><EM>Accounting at start</EM></LI>
<LI> <CODE>connect_grace#</CODE><EM>&nbsp;&nbsp;Time between jobs</EM></LI>
<LI> <CODE>connect_interval#</CODE><EM>&nbsp;&nbsp;Connection interval</EM></LI>
<LI> <CODE>connect_timeout#</CODE><EM>&nbsp;&nbsp;Connection timeout</EM></LI>
<LI> <CODE>control_filter=</CODE><EM>Control file filter</EM></LI>
<LI> <CODE>ff</CODE><EM>&nbsp;&nbsp;form feed</EM></LI>
<LI> <CODE>fo</CODE><EM>&nbsp;&nbsp;form feed on open</EM></LI>
<LI> <CODE>la</CODE><EM>&nbsp;&nbsp;Local printer accounting enabled</EM></LI>
<LI> <CODE>ld=</CODE><EM>leader on open (initialization string)</EM></LI>
<LI> <CODE>lk</CODE><EM>&nbsp;&nbsp;Lock IO device</EM></LI>
<LI> <CODE>lp=</CODE><EM>IO device pathname</EM></LI>
<LI> <CODE>nb</CODE><EM>&nbsp;&nbsp;Nonblocking device open</EM></LI>
<LI> <CODE>network_connect_grace#</CODE><EM>&nbsp;&nbsp;Time between jobs</EM></LI>
<LI> <CODE>of=</CODE><EM>of filter</EM></LI>
<LI> <CODE>retry_econnrefused#</CODE><EM>&nbsp;&nbsp;Retry if open failed</EM></LI>
<LI> <CODE>retry_nolink#</CODE><EM>&nbsp;&nbsp;Retry if open failed</EM></LI>
<LI> <CODE>rm</CODE><EM>&nbsp;&nbsp;the remote machine to send the job to</EM></LI>
<LI> <CODE>rp</CODE><EM>&nbsp;&nbsp;the remote print queue to send the job to</EM></LI>
<LI> <CODE>rw</CODE><EM>&nbsp;&nbsp;device opened RW flag</EM></LI>
<LI> <CODE>server_tmp_dir=</CODE><EM>temporary directory</EM></LI>
</UL>

Sequence of Operations:
<OL>
<LI>During the server operations,
it will try to create temporary files in the print queue spool directory.
If this is not desirable,
it will create them in the <CODE>server_tmp_dir</CODE> directory.</LI>
<LI>If the accounting file specified by
<CODE>af</CODE>
exists,
it is opened (af_fd) and the af_fd is passed as file descriptor
3 to all filters.
If the <CODE>af</CODE> value has the form <CODE>af=|/program</CODE>
then the program is started and the program STDIN is used as af_fd.
If the <CODE>af</CODE> value has the form <CODE>af=host%port</CODE>,
then a TCP/IP connection to the corresponding port on the remote host
is made and the port used as af_fd.
In the latter two cases,  the filter STDIN (file descriptor 0)
is actualy opened read/write, and is used when information is needed
from the accounting filter or remote server.
See
<A HREF="LPRng-HOWTO-11.html#accountingserver">Accounting Printcap Options</A>
for more information on the LPRng accounting support.</LI>
<LI>If the
<CODE>connect_grace</CODE>
value is non-zero and the server is opening a device or
<CODE>network_connect_grace</CODE> is non-zero and a network connection
is being made,
the server will pause the specified time.
This is to accommodate devices which need a recovery time between jobs.</LI>
<LI>The <CODE>lp</CODE> option is checked to determine the type of IO device.
<CENTER><TABLE BORDER><TR><TD>
<BR>
Format</TD><TD>Meaning</TD></TR><TR><TD>
<CODE>/pathname</CODE></TD><TD>Absolute pathname of IO device</TD></TR><TR><TD>
<CODE>pr@host</CODE></TD><TD>transfer to <CODE>pr</CODE> on remote <CODE>host</CODE></TD></TR><TR><TD>
<CODE>host%port</CODE></TD><TD>open a TCP/IP connection to port on host. host can be name or IP address</TD></TR><TR><TD>
<CODE>|filter</CODE></TD><TD>run the filter program; it STDIN will be used as device</TD></TR><TR><TD>

</TD></TR></TABLE></CENTER>
</LI>
<LI>The IO device specified by
<CODE>lp</CODE> is opened write-only or read-write if the
<CODE>rw</CODE>
flag is true, and the resulting file descriptor is io_fd.
If the <CODE>nb</CODE> flag is set,
a non-blocking open will be done as well.
If the <CODE>lk</CODE> (lock device) flag is true,
the device will be locked against use by other LPD servers.</LI>
<LI>If a <CODE>host%port</CODE> combination,
a TCP/IP connection will be opened to the remote port and the connection will
be used as io_fd.</LI>
<LI>If a filter program is specified,
the filter program will be run and the STDIN of the filter will be
used as the device file descriptor.</LI>
<LI>If a <CODE>rp@rm</CODE> combination,
or none of the above combinations are true and the
<CODE>rm</CODE> and <CODE>rp</CODE> values are non-zero,
then the job will be transferred to a remote printer.
The type of operation will be a job transfer,
rather than printing operation.</LI>
<LI>If the <CODE>connect_timeout</CODE> value is non-zero,
a timeout is setup for the device or socket open.
If the device or connection open does not succeed within the timeout,
then the open operation fails.</LI>
<LI>If a connection is to a network address
(i.e. - <CODE>connect()</CODE> system call)
and the connection attempt fails with an <CODE>ECONNREFUSED</CODE>
error,
if the <CODE>retry_econnrefused</CODE>
flag is set then the connection attempt is retried,
but this time using an alternative port number.
See
<A HREF="LPRng-HOWTO-13.html#rfc1179ref">RFC1179</A> for details.
This is repeated until all of the possible originating port numbers
are exhausted.</LI>
<LI>If the open or connect operation fails,
and the <CODE>retry_nolink</CODE> flag is set,
then the server will pause for a minimum of
<CODE>connect_grace</CODE> plus a multiple of
<CODE>connect_interval</CODE> seconds
based on the number of attempts
before retrying the open operation.
Note that the interval may increase as the number of attempts
increases.</LI>
<LI>If printing a job and the
<CODE>of</CODE> filter is specified,
it is created with its STDOUT (fd 1) attached to the io_fd.
Its stdin (of_fd) will be used in the steps listed below.
If there is no
<CODE>of</CODE> filter,
then the of_fd value will be the io_fd descriptor.</LI>
<LI>If transferring a job and the <CODE>control_filter</CODE> option is specified,
then the program specified by the <CODE>control_filter</CODE>
value will be run. It will have its STDIN set to the control file,
and its STDOUT output will be used as the new value of the control file
to transfer to the remote host.
See
<A HREF="#filtercmd">Filter Command Line Flags</A>
for details of options passed to the control filter,
and
<A HREF="#errorcodes">errorcodes</A> for the exit codes of the filter.</LI>
<LI>
<A NAME="accountstart"></A> 
If <CODE>la</CODE> (local accounting) is true and we are printing a job
or <CODE>ar</CODE> (remote accounting) is true and we are transferring a job,
the <CODE>as</CODE> value is examined.
If it is a filter (program) specification,
then the program is started with its STDIN attached to
<CODE>/dev/null</CODE> and STDOUT to the io_fd,
STDERR to the error file,
and file descriptor 3 to the accounting file descriptor af_fd.
The lpd program will wait until it terminates,
and examine the error code for action, as for the filters
(see
<A HREF="#errorcodes">errorcodes</A> below).
If it is a string,
then it is interpreted, the escape sequences replaced with the appropriate
information,  and written to the accounting file.</LI>
<LI>If the <CODE>achk</CODE> (accounting check) flag is set, 
a line is read from the accounting filter af_fd file descriptor.
This line should be <CODE>accept</CODE>,
otherwise the job processing terminates with a JFAIL indication.</LI>
<LI>If the operation is a job transfer, the operation proceeds as outlined in
<A HREF="LPRng-HOWTO-13.html#rfc1179ref">RFC1179</A>,
and then the
<A HREF="#normalterm">Normal Termination</A> operations are
carried out.</LI>
<LI>If the operation is a print operation
and the
<CODE>ld</CODE> (leader on open) value is provided,
the string
is translated (escapes removed)
and written to the of_fd file descriptor.</LI>
<LI>If the
<CODE>fo</CODE> (form feed on open) flag is true, then the
<CODE>ff</CODE> (form feed) string
is translated (escapes removed)
and written to the of_fd file descriptor.</LI>
</OL>

<A NAME="ab"></A> 
<A NAME="hl"></A> 
<A NAME="be"></A> 
<A NAME="bl"></A> 
<A NAME="bp"></A> 
<A NAME="bs"></A> 
<A NAME="sb"></A> 
<A NAME="sh"></A> 
<A NAME="of"></A> 
<A NAME="bannerprinting"></A> <H3>Printing Banner At Beginning</H3>

<P>Options used:
<UL>
<LI> <CODE>ab</CODE><EM>&nbsp;&nbsp;Always print banner (default FALSE)</EM></LI>
<LI> <CODE>be=</CODE><EM>End banner generator program</EM></LI>
<LI> <CODE>bl=</CODE><EM>Short banner line format</EM></LI>
<LI> <CODE>bp=</CODE><EM>Banner generator program</EM></LI>
<LI> <CODE>bs=</CODE><EM>Start banner generator</EM></LI>
<LI> <CODE>hl</CODE><EM>&nbsp;&nbsp;Banner (header) Last</EM></LI>
<LI> <CODE>of=</CODE><EM>Banner and File Separator Filter</EM></LI>
<LI> <CODE>sb</CODE><EM>&nbsp;&nbsp;Short banner (default FALSE)</EM></LI>
<LI> <CODE>sh</CODE><EM>&nbsp;&nbsp;Suppress header (banners) (default FALSE)</EM></LI>
</UL>

Sequence of Operations:
<OL>
<LI>If the
<CODE>sh</CODE> (suppress header) flag is true, no banner is
printed,
and the actions in this section are skipped.</LI>
<LI>If the <CODE>hl</CODE> flag is true, the banner is printed at the end
of the job,
and the actions in this section are skipped.</LI>
<LI>If the user does not supply a banner name,
(the <CODE>L</CODE> line in the control file)
and
<CODE>ab</CODE> (always print a banner) is false
(the default),
then no banner is printed.
If no name is supplied and
<CODE>ab</CODE> is true, then ANONYMOUS is used.</LI>
<LI>There are two types of banners - short and long.
If the
<CODE>sb</CODE> flag is set, then we send the
<CODE>bl</CODE>
(banner line) contents directly to the of_fd;
By default the
<CODE>bl</CODE> value is:
<CODE>bl=$-'C:$-'n Job: $-'J Date: $-'t</CODE>
(See
<A HREF="#filtercmd">Filter Command Line Flags</A>
for details.)
This will get translated to:<BR>
<CODE>papowell:A Job: file1 file2 Date: Thu Nov 27 23:02:04 PST 1997</CODE></LI>
<LI>If the
<CODE>sb</CODE> flag is clear,
we will generate a long banner using a program instead.
If
<CODE>bs</CODE> (start banner) program is specified, then it is used
to generate a banner,
otherwise if the
<CODE>bp</CODE> (banner) program is specified, then it is used
to generate a banner.
If no program is available, we skip the banner generation.
The banner generator program is started with the normal command line
flags
(see
<A HREF="#filtercmd">Filter Command Line Flags</A>),
with its STDOUT attached to the of_fd descriptor.
The short banner string described in the previous step is written
to the STDIN.
The banner printer is responsible for generating a banner
appropriate to the printing device.</LI>
<LI>The
<CODE>ff</CODE> (form feed) string
will be interpreted and sent to the of_fd.</LI>
</OL>

<A NAME="directread"></A> 
<A NAME="sendjobrwtimeout"></A> 
<A NAME="sendqueryrwtimeout"></A> 
<A NAME="sf"></A> 
<A NAME="format"></A> <H3>Printing Job Files</H3>

<P>Options used:
<UL>
<LI> <CODE>Xf=</CODE><EM>Format Filter</EM></LI>
<LI> <CODE>direct_read</CODE><EM>&nbsp;&nbsp;Direct connection to file</EM></LI>
<LI> <CODE>if=</CODE><EM>Default F Format Filter</EM></LI>
<LI> <CODE>pr=</CODE><EM>pr formatting program</EM></LI>
<LI> <CODE>send_job_rw_timeout=</CODE><EM> print job read/write timeout </EM></LI>
<LI> <CODE>send_query_rw_timeout=</CODE><EM> status query operation read/write timeout </EM></LI>
<LI> <CODE>sf</CODE><EM>&nbsp;&nbsp;Suppress FF Print File Separators</EM></LI>
</UL>
<P>Sequence of Operations:
for each job in listed in the control file,
the following operations are done in turn.
<OL>
<LI>If there is an <CODE>of</CODE> filter present,
the suspend string <CODE>\031\001</CODE> is written to of_fd
and the no further action is taken until the of filter is suspended.</LI>
<LI>The control file line for the job is examined,
and the first letter of the data file specification is used as the format.</LI>
<LI>If the format is
<CODE>p</CODE>,
the job is first processed by the program specified by the
<CODE>pr</CODE>
program,
and the program output used as the print file.</LI>
<LI>If the format is
<CODE>f</CODE>,
<CODE>l</CODE>,
or
<CODE>p</CODE>
then the <CODE>if</CODE> filter is used,
otherwise the keyword
<CODE>Xf</CODE> is used.
Note that certain formats such as
<CODE>p, a, l</CODE>, may not be used as formats.</LI>
<LI>The
<CODE>direct_read</CODE>
flag determines how the print file is provided
to the filter.
Normally, the <CODE>lpd</CODE> writes the file to the filter process,
and can monitor the printing activity in this way.
However,
some filters require a direct connection in order to
do <CODE>lseek</CODE> or other operations on the file.
If the
<CODE>direct_read</CODE>
flag is true,
then the print file is opened and passed directly to the filter
process,
otherwise the <CODE>lpd</CODE> program will read the file
and write its contents to the filter.</LI>
<LI>The filter program is started with an appropriate set of command line options
(see
<A HREF="#filtercmd">Filter Command Line Flags</A>),
and with its STDOUT attached to the printing device (io_fd),
STDERR to the log file (<CODE>lf</CODE>),
and file descriptor 3 to the accounting fd af_fd.
If <CODE>direct_read</CODE> is false,
the file is then written to the STDIN of the filter.
This allows the server to monitor job progress.</LI>
<LI>When doing a read/write operation to a device or remote system,
a timeout can be specified.
When doing a print or job transfer operation,
the <CODE>send_job_rw_timeout</CODE> value is used.
When doing a status or query operation,
the <CODE>send_query_rw_timeout</CODE> value is used.
If a write or write operation does not complete within
the specified timeout seconds, then we have an error
condition and job processing or the query operation
is terminated with JFAIL status.
If the timeout value is 0, then no timeout is done.</LI>
<LI>
<A NAME="errorcodes"></A> 
<CODE>lpd</CODE> will then wait for the filter to exit.
The exit status can be as follows:
<PRE>
Key      Value   Meaning
JSUCC    0       Successful
JFAIL    1, 32   Failed - retry later
JABORT   2, 33   Abort - terminate queue processing
JREMOVE  3, 34   Failed - remove job
JHOLD    6, 37   Failed - hold this job
Other            Abort - terminate queue processing
</PRE>
</LI>
<LI>If the filter exit status was JSUCC (0), or no error indicated,
then processing will continue otherwise the job termination takes
(see
<A HREF="#termination">Abnormal Termination</A>).</LI>
<LI>If the <CODE>of</CODE> filter is present,
then it is reactivated with a <CODE>kill -CONT</CODE> signal.</LI>
<LI>If the <CODE>sf</CODE> (suppress FF print file separators ) is false,
then the
<CODE>ff</CODE> (form feed) string
will be interpreted and sent to the of_fd.</LI>
</OL>
<H3>Printing Banner At End</H3>

<P>Options used:
<UL>
<LI> <CODE>hl</CODE><EM>&nbsp;&nbsp;Header (Banner) Last</EM></LI>
</UL>
<P>The actions taken in this step are identical to those for the
<A HREF="#bp">Printing Banner At Beginning</A>,
with the exception that the
<CODE>be</CODE> (end banner program) is used in the procedure
rather than the
<CODE>bs</CODE> (start banner program).
<A NAME="ae"></A> 
<A NAME="fq"></A> 
<A NAME="savewhendone"></A> 
<A NAME="tr"></A> 
<A NAME="normalterm"></A> <H3>Normal Termination</H3>

<P>Options used:
<UL>
<LI> <CODE>fq</CODE><EM>&nbsp;&nbsp;Form Feed on Close</EM></LI>
<LI> <CODE>la</CODE><EM>&nbsp;&nbsp;Local Printer Accounting</EM></LI>
<LI> <CODE>tr=</CODE><EM>Trailer on Close</EM></LI>
<LI> <CODE>ae=</CODE><EM>Accounting at end</EM></LI>
<LI> <CODE>save_when_done</CODE><EM>&nbsp;&nbsp;Save when done</EM></LI>
</UL>
<P>Sequence of Operations:
<OL>
<LI>If we are printing and the <CODE>fq</CODE> flag is set and the
<CODE>sf</CODE> (suppress interfile FF) flag is set,
then the
<CODE>ff</CODE> (form feed) string
will be interpreted and sent to the of_fd.</LI>
<LI>If we are printing, the <CODE>tr</CODE> (trailer) string
will be interpreted and sent to the of_fd.</LI>
<LI>If printing and the <CODE>la</CODE> (local printer accounting) flag is set
or transferring a job and the <CODE>ar</CODE> (remote accounting) flag is set,
the
<CODE>ae</CODE> is examined and accounting is done as described
for the
<CODE>
<A HREF="#accountstart">as</A> field.</CODE></LI>
<LI>If the <CODE>of</CODE> filter is present,
its STDIN is closed,
and the <CODE>lpd</CODE> server waits for it to exit.
The exit status is used as described above.</LI>
<LI>The device (io_fd) is closed.</LI>
<LI>The job is marked as completed in the spool queue.</LI>
<LI>If the <CODE>save_when_done</CODE> flag is not specified,
the job is removed.</LI>
</OL>

<A NAME="rt"></A> 
<A NAME="saveonerror"></A> 
<A NAME="sendtry"></A> 
<A NAME="sendfailureaction"></A> 
<A NAME="mailfrom"></A> 
<A NAME="mailoperatoronerror"></A> 
<A NAME="sendmail"></A> 
<A NAME="stoponabort"></A> 
<A NAME="maxconnectinterval"></A> 
<A NAME="termination"></A> <H3>Abnormal Termination</H3>

<P>Options used:
<UL>
<LI> <CODE>mail_from=</CODE><EM>Mail from user name</EM></LI>
<LI> <CODE>mail_operator_on_error=</CODE><EM>Mail to operator on error</EM></LI>
<LI> <CODE>rt#</CODE><EM>&nbsp;&nbsp;Maximum Print or Transfer Attempts</EM></LI>
<LI> <CODE>send_try#</CODE><EM>&nbsp;&nbsp;(alias for <CODE>rt</CODE></EM></LI>
<LI> <CODE>save_on_error</CODE><EM>&nbsp;&nbsp;Do not delete on error</EM></LI>
<LI> <CODE>send_failure_action=</CODE><EM>Action on Failure</EM></LI>
<LI> <CODE>sendmail=</CODE><EM>sendmail path name and options</EM></LI>
<LI> <CODE>stop_on_abort</CODE><EM>&nbsp;&nbsp;Stop processing queue on filter abort</EM></LI>
</UL>
<P>If the job processing terminates abnormally,
the following sequence of events occurs:
<OL>
<LI>The job is marked as having an error during processing.</LI>
<LI>The LPD server will attempt to kill all filters and other associated process
by using a sequence of
<CODE>kill -INT</CODE>,
<CODE>kill -QUIT</CODE>,
and finally
<CODE>kill -KILL</CODE> operations.</LI>
<LI>If there is a <CODE>mail_operator_on_error</CODE> value,
the specified operator will be mailed an error indication.
The <CODE>sendmail</CODE> option specifies the pathname of the
<EM>sendmail</EM> program and the options needed to have it read
mail addresses from its standard input.
For example, <CODE>sendmail=/usr/sbin/sendmail -oi -t</CODE>
is a commonly used set of options.</LI>
<LI>The <CODE>mail_from</CODE> value specifies the user name used for
mail origination.  If not specified, the default is to use the print spool
queue or printer name.</LI>
<LI>If there is a <CODE>send_failure_action</CODE> specified,
then it is decoded and the corresponding action taken.
If the value is
<CODE>remove</CODE>,
<CODE>hold</CODE>,
<CODE>abort</CODE>,
or
<CODE>retry</CODE>,
then the job is removed, held, aborted, or retried.
If the value is <CODE>|/program</CODE>,
the program is executed and
the number of attempts are written to the filter STDIN.
The exit status of the filter will be used to determine the consequent actions.
That is, JSUCC (0) will be success, and the standard success action will
be taken;
JFAIL will cause retry,
JREMOVE will cause the job to be removed,
JHOLD will cause the job to be held,
JABORT or other status will abort processing.</LI>
<LI>If the status is ABORT and the
<CODE>stop_on_abort</CODE>
flag is set,
then further processing of jobs is terminated.
The job is not removed from the queue.</LI>
<LI>If the error status indicates removal,
and the <CODE>save_on_error</CODE> flag is clear
then the job is removed from the spool queue.</LI>
<LI>If the error status indicates that no further operations should
be performed on the queue,
then the <CODE>lpd</CODE> server will stop processing jobs.</LI>
<LI>If the error code indicated that the job should be retried,
and the
<CODE>rt</CODE> value is 0 or the number of attempts is less than
the <CODE>rt</CODE> value,
then the job is retried.
Between each attempt to transfer a job to a remote site.
This pause will double after each attempt,
reaching a maximum of <CODE>max_connect_interval</CODE> seconds.
If <CODE>max_connect_interval</CODE> is 0, there is no limit on the interval value.</LI>
</OL>

<A NAME="lpdforcepoll"></A> 
<A NAME="lpdpolltime"></A> 
<A NAME="maxserversactive"></A> <H3>LPD Spool Queue Processing</H3>

<P>Options used:
<UL>
<LI> <CODE>lpd_force_poll=</CODE><EM>Force LPD to periodically poll print queues </EM></LI>
<LI> <CODE>lpd_poll_time#</CODE><EM>Time between polls</EM></LI>
<LI> <CODE>max_servers_active#</CODE><EM>Maximum number of active servers</EM></LI>
</UL>
<P>When the <CODE>lpd</CODE> server starts,
it will fork a set of subserver processes,
each which will handle an individual queue.
<P>If a system has a large number of queues,
then this forking operation may result in the <CODE>lpd</CODE> server
exhausting the process resources.
To control this,  the
<CODE>max_servers_active</CODE> value restricts the number of active
children to the specified value.
If this value is 0,
then 50% of the maximum system processes value will be used.
<P>Due to the limits on the number of processes,
there may be times when a job is placed in a queue,
but the <CODE>lpd</CODE> server is unable to start handling the job.
When all of the children of the main <CODE>lpd</CODE> server have
exited,
the server starts a timer.
After <CODE>lpd_poll_time</CODE> seconds,  it will scan the queues,
looking for jobs to process,
and starts a process to service them.
If it does not find any jobs it remains idle.
<P>The <CODE>lpd_force_poll</CODE> flag causes the server to periodically
poll the queues.
This is useful when there is a high possibility that jobs could fail to be
printed due to high loads on the server.
<A NAME="bkfilteroptions"></A> 
<A NAME="bkoffilteroptions"></A> 
<A NAME="bkf"></A> 
<A NAME="filteroptions"></A> 
<A NAME="offilteroptions"></A> 
<A NAME="filterldpath"></A> 
<A NAME="filterpath"></A> 
<A NAME="passenv"></A> 
<A NAME="pl"></A> 
<A NAME="pw"></A> 
<A NAME="px"></A> 
<A NAME="py"></A> 
<A NAME="filtercmd"></A> <H2><A NAME="ss6.7">6.7 Filter Command Line Flags</A>
</H2>

<P>Options used:
<UL>
<LI> <CODE>bk_filter_options=</CODE><EM>Backwards Compatible Filter options</EM></LI>
<LI> <CODE>bk_of_filter_options=</CODE><EM>Backwards Compatible OF Filter options</EM></LI>
<LI> <CODE>bkf</CODE><EM>&nbsp;&nbsp;Backwards Compatible Filters</EM></LI>
<LI> <CODE>filter_ld_path=</CODE><EM>Filter LD_LIBRARY_PATH environment</EM></LI>
<LI> <CODE>filter_options=</CODE><EM>Filter options</EM></LI>
<LI> <CODE>filter_path=</CODE><EM>Filter PATH environment</EM></LI>
<LI> <CODE>of_filter_options=</CODE><EM>OF Filter options</EM></LI>
<LI> <CODE>pass_env=</CODE><EM>Environment variables to copy to Filter environment</EM></LI>
<LI> <CODE>pl#</CODE><EM>line count for page</EM></LI>
<LI> <CODE>pw#</CODE><EM>column count for page</EM></LI>
<LI> <CODE>px#</CODE><EM>pixel width for page</EM></LI>
<LI> <CODE>py#</CODE><EM>pixel length for page</EM></LI>
</UL>
<P>A filter (or program) specification in the LPRng printcap database
usually has the form:
<PRE>
:option=| [flags] /path [arguments]
:option=[flags] /path [arguments]
</PRE>
<P>The first case is used where the option value can be a string or filter,
and the second where a program is always expected.
The following procedure is used to run a filter program.
<P>The sequence of operations to run a filter is as follows:
<OL>
<LI>The program must be specified with an absolute path name.</LI>
<LI>By default, the program is run as the user if invoked from a client
program such as <CODE>lpr</CODE>, <CODE>lpc</CODE>, etc.
If invoked from <CODE>lpd</CODE>,  it is run as the
<CODE>server_user</CODE>
user
(default <CODE>daemon</CODE>) configuration entry.</LI>
<LI>The
<EM>flags</EM> control how the program is to be run.
The following flags are supported:
<UL>
<LI><B>ROOT</B>
This opens a horrible security loophole,
as it will run the program as ROOT.
To enable this option,
you must set various compilation flags,
and perform other arcane operations.
This is deliberately done to make administrators
read the warnings and admonitions.
<P>The alternative to ROOT is to have a setuid ROOT executable.
Under NO circumstances should you run a shell script setuid ROOT,
with general execute permissions on it.
</LI>
<LI><B>-$</B>
This very odd looking flag is used to suppress the addition of
additional command line arguments
specified by the value of <CODE>filter_options</CODE>
to the program command line.</LI>
</UL>
</LI>
<LI>If the <B>-$</B> flag is not specified,
the arguments determined by the value of the <CODE>bkf</CODE>
(Berkeley LPD filter compatible flag) flag are added to the
filter command line.
If <CODE>bkf</CODE> is false the
<CODE>filter_options</CODE> are added for OF filters and
<CODE>of_filter_options</CODE>
are added for non-OF filters;
if it is true, then the
<CODE>bk_filter_options</CODE> and <CODE>bk_of_filter_options</CODE> are added for
OF and non-OF filters respectively.
<P>
<CENTER><TABLE BORDER><TR><TD>
<BR>
Option</TD><TD>DefaultValue</TD></TR><TR><TD>
<CODE>filter_options</CODE></TD><TD>$C $F $H $J $L $P $Q $R $Z $a $c $d $e $f $h $i $j $k $l $n $p$r $s $w $x $y $-a</TD></TR><TR><TD>
<CODE>of_filter_options</CODE></TD><TD>(same as <CODE>filter_options</CODE>)</TD></TR><TR><TD>
<CODE>bk_filter_options</CODE></TD><TD>$P $w $l $x $y $F $c $L $i $J $C $0n $0h $-a</TD></TR><TR><TD>
<CODE>bk_of_filter_options</CODE></TD><TD>$w $l $x $y</TD></TR><TR><TD>

</TD></TR></TABLE></CENTER>
<P>
</LI>
<LI>By default,
for programs that are not being invoked as print job file filters,
the
<CODE>filter_options</CODE>
arguments are added.
For print job filters, if the <CODE>bkf</CODE> flag is set,
then the
<CODE>bk_filter_options</CODE>
and
<CODE>bk_of_filter_options</CODE>
entries are used.
The default <CODE>bk</CODE> filter options are the same as originally used
with the BSD LPR filters.
For the <CODE>of</CODE> filter,
either the <CODE>of_filter_options</CODE>
or <CODE>bk_of_filter_options</CODE> arguments will be added.</LI>
<LI>The program arguments will then be scanned and interpreted.
Arguments of the form <CODE>$</CODE><EM>letter</EM> will be
translated into values from the
print job control file and/or printcap entry.
The letters have the following meaning:
<CENTER><TABLE BORDER><TR><TD>
<BR>
Letter</TD><TD>TranslatedValue</TD></TR><TR><TD>
<CODE>a </CODE></TD><TD>printcap <CODE>af</CODE> (accounting file name)</TD></TR><TR><TD>
<CODE>b </CODE></TD><TD>job size (in K bytes)</TD></TR><TR><TD>
<CODE>c </CODE></TD><TD>binary file (<CODE>l</CODE> format for print file)</TD></TR><TR><TD>
<CODE>d </CODE></TD><TD>printcap <CODE>cd</CODE> or <CODE>sd</CODE> entry</TD></TR><TR><TD>
<CODE>e </CODE></TD><TD>print job data file name (currently being processed)</TD></TR><TR><TD>
<CODE>f </CODE></TD><TD>print job original name when spooled for printing (N info from control file)</TD></TR><TR><TD>
<CODE>h </CODE></TD><TD>print job originating host (H info from control file)</TD></TR><TR><TD>
<CODE>i </CODE></TD><TD>indent request (I info from control file)</TD></TR><TR><TD>
<CODE>j </CODE></TD><TD>job number in spool queue</TD></TR><TR><TD>
<CODE>k </CODE></TD><TD>print job control file name</TD></TR><TR><TD>
<CODE>l </CODE></TD><TD>printcap <CODE>pl</CODE> (page length)</TD></TR><TR><TD>
<CODE>m </CODE></TD><TD>printcap <CODE>co</CODE></TD></TR><TR><TD>
<CODE>n </CODE></TD><TD>user name (L info from control file)</TD></TR><TR><TD>
<CODE>p </CODE></TD><TD>remote printer (when processing for bounce queue)</TD></TR><TR><TD>
<CODE>r </CODE></TD><TD>remote host (when processing for bounce queue)</TD></TR><TR><TD>
<CODE>s </CODE></TD><TD>printcap <CODE>sf</CODE> (status file)</TD></TR><TR><TD>
<CODE>t </CODE></TD><TD>time in common UNIX format</TD></TR><TR><TD>
<CODE>w </CODE></TD><TD>printcap <CODE>pw</CODE> (page width)</TD></TR><TR><TD>
<CODE>x </CODE></TD><TD>printcap <CODE>px</CODE> (page x dimension)</TD></TR><TR><TD>
<CODE>y </CODE></TD><TD>printcap <CODE>py</CODE> (page y dimension)</TD></TR><TR><TD>
<CODE>F </CODE></TD><TD>print file format</TD></TR><TR><TD>
<CODE>P </CODE></TD><TD>printer name</TD></TR><TR><TD>
<CODE>S </CODE></TD><TD>printcap <CODE>cm</CODE> (comment field)</TD></TR><TR><TD>
Capital letter</TD><TD>Corresponding line from control file</TD></TR><TR><TD>
{key}</TD><TD>printcap value for <CODE>key</CODE></TD></TR><TR><TD>

</TD></TR></TABLE></CENTER>
</LI>
<LI>If there is no value for the specified argument,
then the argument is removed from the list.
If there is a value, the actual form of the substitution is
controlled by additional flags as follows.
<CENTER><TABLE BORDER><TR><TD>
<BR>
Form</TD><TD>TranslatedValue</TD></TR><TR><TD>
<CODE> $x </CODE></TD><TD><CODE>'-x<EM>value</EM>' </CODE></TD></TR><TR><TD>
<CODE> $-x </CODE></TD><TD><CODE> '<EM>value</EM>' </CODE></TD></TR><TR><TD>
<CODE> $0x </CODE></TD><TD><CODE> -x '<EM>value</EM>' </CODE></TD></TR><TR><TD>
<CODE> $'x </CODE></TD><TD><CODE> -x <EM>value</EM> </CODE></TD></TR><TR><TD>

</TD></TR></TABLE></CENTER>

<P>Each entry in quotes is treated as a single value,
as in /bin/sh.
The <CODE>$'x</CODE> does not quote the value.
Combinations of the various flags are allowed.  For example,
<CODE>$-x</CODE> would simply substitute the value for <CODE>x</CODE>,
and then pass the whitespace separated components as individual arguments.
This last form is useful for adding in additional flags on the command line.
</LI>
<LI>The command line is parsed,
metacharacters are ruthlessly stripped from all arguments and pathnames
and replaced by <CODE>_</CODE> (underscores),
and an argument list suitable for the <CODE>execve</CODE> system call
is formed.</LI>
<LI>A sanitized environment is set up for the program execution,
with the following environment variables.
<P>
<CENTER><TABLE BORDER><TR><TD>
<BR>
<CODE> USER </CODE></TD><TD>User name (client only)</TD></TR><TR><TD>
<CODE> LOGNAME </CODE></TD><TD>L control file info</TD></TR><TR><TD>
<CODE> HOME </CODE></TD><TD>Home directory (client only)</TD></TR><TR><TD>
<CODE> LOGDIR </CODE></TD><TD>Home directory (client only)</TD></TR><TR><TD>
<CODE> PATH </CODE></TD><TD><CODE>filter_path</CODE> configuration information</TD></TR><TR><TD>
<CODE> LD_LIBRARY_PATH </CODE></TD><TD><CODE> filter_ld_path </CODE> configuration information</TD></TR><TR><TD>
<CODE> SHELL </CODE></TD><TD><CODE>/bin/sh</CODE></TD></TR><TR><TD>
<CODE> IFS </CODE></TD><TD><CODE>" \t"</CODE></TD></TR><TR><TD>
<CODE> TZ </CODE></TD><TD>Time zone</TD></TR><TR><TD>
<CODE> SPOOL_DIR </CODE></TD><TD><CODE>sd</CODE> printcap info</TD></TR><TR><TD>
<CODE> CONTROL_DIR </CODE></TD><TD><CODE>cd</CODE> printcap info</TD></TR><TR><TD>
<CODE> PRINTCAP_ENTRY </CODE></TD><TD>printcap info</TD></TR><TR><TD>
<CODE> CONTROL </CODE></TD><TD>control file</TD></TR><TR><TD>

</TD></TR></TABLE></CENTER>
<P>
</LI>
<LI>If the filter is to be run by a client program such as <CODE>lpr</CODE>,
then the environment variables specified by the
<CODE>pass_env</CODE> configuration or printcap option will be
extracted from the environment,
have any metacharacters removed,
and then placed in the environment variable list.
Commonly, the
<CODE>PGPPASS</CODE> and <CODE>PGPPATH</CODE> are specified.</LI>
<LI>The program is started,
with STDIN, STDOUT, and STDERR attached to the appropriate files or
file descriptors.
If none is specified, then they are attached to
<CODE>/dev/null</CODE>.</LI>
</OL>
<H2><A NAME="ss6.8">6.8 Bounce queues and filters: caveats</A>
</H2>

<P>There are a few situations in which a filter of a bounce queue will
behave differently from an ordinary queue.
<H2><A NAME="ss6.9">6.9 The lpr -p  format and :pr filter</A>
</H2>

<P>The <CODE>-p</CODE> format doesn't behave as expected. Instead of running
<CODE>pr | if</CODE>, the daemon will try to call the <CODE>:pf</CODE> filter.
<P>After filtering, the file might be of a different type than before.
Since the result is transfered to another print service (which might
do its own filtering), it is important that the right file type (by
means of the print format) is passed on to the second queue.
<P>Use the
<CODE>
<A HREF="LPRng-HOWTO-5.html#translateformat">translate_format</A>
=oNoN...</CODE>
printcap option.
Its value takes the form of old/new pairs of formats. For example:
<PRE>
translate_format=pf
</PRE>
<P>The <CODE>-p</CODE> format file will now be renamed with the
<CODE>f</CODE> format.
<H2><A NAME="ss6.10">6.10 LPRng Supported Filters</A>
</H2>

<P>There already exists a large library of ready-to-use filters. Some of
them have LPRng-specific versions, which can be found at the
<A HREF="LPRng-HOWTO-1.html#secftp">LPRng ftp mirror sites</A>.
<H3>Filter Distribution Conventions</H3>

<P>By convention,
most filters are either totally standalone (very rare),
or require a set of support files.
There are two types of support files: per print queue configuration information
and global support information.
<P>Since a print filter will execute with the current directory set to the
spool queue directory,
most filters expect that per print queue configuration information
should be kept in the spool directory.
Most <EM>vintage</EM> filters insist on having these files <EM>hidden</EM>
with names such as <B><CODE>.setup</CODE></B>.
This can make it difficult for administrators to determine where the
configuration files are.
<P>It is strongly recommended that filters and information
be placed in commonly accessible directories such as
<CODE><B>/usr/local/lib/filters</B></CODE>,
and the executables in subdirectories.
This allows the LPRng administrator to set the privileges on these
directories such that only the <CODE>lpd</CODE> process can
access them.
<P>Most of the LPRng supported filters can either be used as a
<CODE>if</CODE> or <CODE>of</CODE> filter.
The filter will examine the format type passed by the <CODE>-F<EM>X</EM></CODE>
command line argument,
and if it is <CODE>o</CODE> it will perform as an <CODE>of</CODE> filter.
<P>Alternatively,
the filter will check the filename in the pathname by which is was invoked.
If the name has the substring <CODE>of</CODE> in the filename,
then it assumes it is to act as an <CODE>of</CODE> filter.
This allows symbolic links to be made to a common filter executable,
each of which corresponds to the filter name by which it is to be invoked.
<P>When a filter is invoked,
it is passed a large number of options,
many of which are totally ignored in filter operation.
However,
for many purposes it is necessary to provide options to the
filters to tailor their operation to the particular spool queue needs.
<P>By convention,
all LPRng supported filters use the
<PRE>
-Tkey=value[,key=value]
</PRE>
<P>convention for specifying filter configuration option values.
<A NAME="lpf"></A> <H3>lpf</H3>

<P>Source code:
<A HREF="LPRng-HOWTO-1.html#secftp">LPRng Distribution</A><P>This filter is distributed as part of the LPRng source code,
and has a very limited functionality.
By default,
it only translates <CODE>\n</CODE> to <CODE>\r\n</CODE>
sequences,
and detects the OF Filter Stop sequence when invoked as an OF filter.
<UL>
<LI>Options:<BR>
<CODE>-Tcrlf</CODE> - suppress <CODE>\n</CODE> to <CODE>\r\n</CODE> translation</LI>
</UL>

<A NAME="ifhp"></A> <H2><A NAME="ss6.11">6.11 CTI-ifhp ifhp Filters</A>
</H2>

<P>Source code:
<A HREF="LPRng-HOWTO-1.html#secftp">LPRng Distribution, CTI-ifhp-&lt;em>version&lt;/em>.tgz</A><P>This filter supports a wide variety of Hewlett-Packard printers,
or to be more specific,
printers which support the Hewlett-Packard PCL and/or PJL languages.
In addition,
they try to detect PostScript jobs and send the correct commands to the
printers to enable PostScript rather than PJL operation.
<P>This filter was originally developed by
Panos Dimakopoulos, Systems Programmer,
of the CTI-Print project
at the Division of Computing Facilities of the Computer
Technology Institute (CTI), Patras, Greece.
The code has been heavily modified by Patrick Powell
<CODE>&lt;papowell@astart.com></CODE>
to support newer versions of HP Printers.
It is intended to replace the HPJetDirect drivers supplied by Hewlett-Packard.
<H3>Printer Capabilities</H3>

<P>As explained in
<A HREF="LPRng-HOWTO-2.html#installref">Setting Up Your Printer</A>,
you can have a parallel (unidirectional),
serial (bidirectional),
or network (bidirectional) connection.
When using a bidirectional connection,
you can sometime obtain or gratuitously receive error and/or status
information from the printer.
<P>Some printers will spontaneously generate error messages when printing
a job on a bidirectional interface.
Usually, though,
it it necessary to force the printer to provide status in a reasonable format.
<P>Some printers have the capability of printing either PCL or PostScript;
some require special setup commands and some will <EM>autosense</EM> which
type of job is being printed.
<P>If you are printing text,
and not using a Page Description Language like PostScript or PCL,
then you may want to download a font to the printer.
This is especially the case when you are trying to print text files
in a non-English font.
<P>Some printers will provide a <EM>hardware</EM> page counter value when requested;
however,
the means of requesting differ from model to model.
<P>Sometimes you want to generate a special banner for a particular printer,
and need to put in some dynamic information.
While this can be done by the <CODE>lpd</CODE> server using the
<CODE>bp</CODE> program specification,
it turns out that non-LPRng systems which want to use the <CODE>ifhp</CODE>
want to have the same facilities.
Thus,  you need to have some way to get the same effect as the <CODE>bp</CODE>
option,  but at the filter level.
<P>Having done <CODE>lpd</CODE> banner generation and printing,
why not have the filter run an accounting script as well?
<P>At this point,  I suspect that the reader is beginning to suspect that
making a general purpose filter to support all of these possibilities is
difficult.
That is incorrect.  It is <B>extremely</B> difficult.
<H3>hpif Options</H3>

<P>These options are specified by the <CODE>-Tkey=value [key=value]*</CODE>
on the command line.
<P>
<CENTER><TABLE BORDER><TR><TD>
<BR>
Option</TD><TD>Purpose</TD></TR><TR><TD>
<CODE>accounting=accounting_script_pathname</CODE></TD><TD>Invoke the accounting script with a subset of theoptions passed to the filter. In addition, the-bpagecount option indicates the number of pagesprinted for the job.</TD></TR><TR><TD>
<CODE>autodetect=[on|off*]</CODE></TD><TD>The printer has or does not have job type autode-tect capability. Do not download fonts or try todetermine job type if autodetect is on.</TD></TR><TR><TD>
<CODE>banner=[on|off*]</CODE></TD><TD>If banner is on, then the ifhp filter will attemptto print a banner using information passed on thecommand line or on the standard input. The titleoption can be used to specify additional titleinformation on the banner. See BANNERS below fordetails.</TD></TR><TR><TD>
<CODE>cartridge=[*on|off]</CODE></TD><TD>(Alias for postscript)If cartridge is on, the printer has PostScript sup-port. The filter will try to determine if a job ispostscript and send Printer Job Language commandsto put the printer in PostScript mode.</TD></TR><TR><TD>
<CODE>debug=debuglevel</CODE></TD><TD>Sets the debugging level; 2 is the default; alarger number causes more verbose error messages.</TD></TR><TR><TD>
<CODE>defaultfont=fontname</CODE></TD><TD>Sets the default font to be downloaded; default isNONE.</TD></TR><TR><TD>
<CODE>dev=/device or dev=host%port</CODE></TD><TD>Open the specified device or connection to remotehost; by default ifhp filter uses file descriptor 1(stdout). If the optional orig_port is specified,connections will be originated from this port.Some printers require that connections originatefrom a port in the range 1-1024.</TD></TR><TR><TD>
<CODE>infostatus=[*on|off]</CODE></TD><TD>The PJL INFOSTATUS request is not supported on someHP printers. Use this to turn the status requestoff. Note that you cannot get real time reports ofthe printer status if you do this. This will alsosuppress getting pagecount information using thePJL facilities.</TD></TR><TR><TD>
<CODE>forcepagecount=[on|off*]</CODE></TD><TD>If you have a printer that has PostScript pagecount information support, you can set infostatusto OFF and forcepagecount to ON. This will causethe PostScript facility to be used. If you setcartridge or postscript to OFF then this will notbe done.</TD></TR><TR><TD>
<CODE>logall</CODE></TD><TD>Save all of the error and information messages fromthe printer in the log file. This is useful whenyou wish to examine returned status from theprinter.</TD></TR><TR><TD>
<CODE>model=(C5M|III|IIID|IIISi|IV*)</CODE></TD><TD>The model of HP printer. C5M is Color 5M, III isHP LaserJet 3, IIID is HP LaserJet 3D, etc. Addi-tional printers may be added or defined at varioustimes - please consult the source for details.This selects various timing and format characteristic-tics. This is a desperation parameter for userswith antique or non-conforming PJL based equipment;read the source code for details on the particularpeculiarities.</TD></TR><TR><TD>
<CODE>pagecount=[on*|off]</CODE></TD><TD>Get the hardware pagecounter value for accounting.Some printers such as the HP LJ4s do not have hard-ware support for pagecounters, and return bogusnumbers. Use this to suppress attempting to getvalid information. If your printer does supportPostScript, then you can get the page count valueusing PostScript by setting forcepagecount to ON.</TD></TR><TR><TD>
<CODE>plp=[on|off*]</CODE></TD><TD>Return PLP status values on exit; by default LPRngstatus values are returned.</TD></TR><TR><TD>
<CODE>postscript=[on*|off]</CODE></TD><TD>The printer has postscript support.</TD></TR><TR><TD>
<CODE>quiet=[on|off*]</CODE></TD><TD>If set, do not report common status messages.</TD></TR><TR><TD>
<CODE>retries=count</CODE></TD><TD>The number of times to retry connecting to theprinter.</TD></TR><TR><TD>
<CODE>sleep=time</CODE></TD><TD>The number of seconds to wait before trying to con-nect to the printer.</TD></TR><TR><TD>
<CODE>status=[*on|off]</CODE></TD><TD>When on, the printer is treated as a write onlydevice and is not queried for pagecount and statusinformation. Set status=OFF for parallel printers.If status is OFF, then the ifhp filter simply addsjob control language headers, fonts, and trailersto the jobs.</TD></TR><TR><TD>
<CODE>stty=stty flags</CODE></TD><TD>if the output device is a serial line, set the linecharacters according to the stty flags. Theseflags are (most likely) identical to those avail-able with the stty(1) command on the host system.</TD></TR><TR><TD>
<CODE>summary=[filename|host%port]</CODE></TD><TD>This option specifies that summary or informationalmessages should be placed in the specified file orsent, using the UDP protocol, to the indicated hostand port address. This allows remote monitoring ofthe printing and error activity. The undocumentedprogram included with the filter distribution is asimple program that can be used to perform the mon-itoring.</TD></TR><TR><TD>
<CODE>sync=[*on|off]</CODE></TD><TD>Try to synchronize communications with printer.This will ensure that the printer has been reset,and no problems involving the previous job willresult.</TD></TR><TR><TD>
<CODE>tbcp=[on|*off]</CODE></TD><TD>When invoked as an IF filter and transferring aPostScript job, the filter will use the AdobeTagged Binary Communications protocol. This allowsbinary data to be transferred and not interpretedas control information.</TD></TR><TR><TD>
<CODE>title=line[/line]*</CODE></TD><TD>The title information is printed on the bannerpage; it consists of a list of / separated lineswhich are added to the banner information.</TD></TR><TR><TD>
<CODE>wrap=[on|off*]</CODE></TD><TD>enables or disables line wrapping in PCLmode.</TD></TR><TR><TD>

</TD></TR></TABLE></CENTER>
<H3>Parallel Port Printer</H3>

<P>On a parallel port printer, you cannot get status, or do much besides
set up the printer to either handle PostScript or do autosensee.
The following is a typical printcap entry:
<PRE>
pr:.... options
  :of=/usr/local/lib/filters/ifhp -Tstatus=off
  :if=/usr/local/lib/filters/ifhp -Tstatus=off
</PRE>
<P>You might want to also look at the <CODE>autodetect</CODE>
or <CODE>postscript</CODE> options.
<A NAME="ifhpbanner"></A> <H3>Printing Banners</H3>

<P>By default, the <CODE>ifhp</CODE> filter when used as an OF filter will
interpret the first line to it as a
<EM>short banner</EM> line,
and use the information on this line to produce a PCL based banner.
The short banner line should have the format:
<P><EM>class</EM>:<EM>username</EM> <CODE>Job:</CODE> <EM>jobinfo</EM> <CODE>Date:</CODE> <EM>dateformat</EM>
<P>
<PRE>
Example:
  A:papowell Job: (stdin) Date: Sun Dec 14 07:13:34 PST 1997
</PRE>
<P>This is produced by the default
short banner line option value:
<PRE>
bl=$-'C:$-'n Job: $-'J Date: $-'t
</PRE>
<P>If you want to suppress banner printing,
then you need to suppress generation of this short banner line.
If you want to have the <CODE>lpd</CODE> program to generate the
default <EM>long</EM> special banner,
then you need to suppress <CODE>ifhp</CODE> from interpreting the
information sent to is as banner information.
Finally, you may want to have <CODE>lpd</CODE> invoke the <CODE>bp</CODE>
(banner program) and have its output used as the banner.
Here are the various possible ways:
<P>
<PRE>
# no banner at all, use :sh: - suppress headers
lp:....
  :sh
  :of=/usr/local/lib/filters/ifhp
# have ifhp generate banner from short banner input
lp:....
  :sb
  :of=/usr/local/lib/filters/ifhp
# have LPD generate long banner, have of filter pass it
lp:...
  :sb@
  :of=/usr/local/lib/filters/ifhp -Tbanner=off
# have LPD invoke bp banner generation program, have of filter pass it
# bp programs require short banner on STDIN to work, so we need to
# generate short banner
lp:...
  :sb
  :bp=/usr/local/lib/filters/banner_program
  :of=/usr/local/lib/filters/ifhp -Tbanner=off
</PRE>
<P>The <CODE>ifhp</CODE> banner is generated in PCL,
and uses the minimum PCL facilities.
Since when you send a banner to an autosensing printer you cause it to enter
the requested mode, the <CODE>if</CODE> filter (<CODE>ifhp</CODE>) will need to reset
the printer to autosense mode.  The <CODE>ifhp</CODE> filter automatically does this.
<P>If you want very fancy banners,
the
<CODE>banner.sh</CODE> (PCL) and
<CODE>psbanner.sh</CODE> (PostScript) banner generating programs
in the CTI-ifhp distribution make a good starting point.
<A NAME="ifhperror"></A> <H3>Error Logging</H3>

<P>Error logging and reporting is done by the <CODE>ifhp</CODE>
filter as follows.
<OL>
<LI>Messages are produced by the actions of the <CODE>ifhp</CODE>
software.
This are logged to the STDERR output of the filter.</LI>
<LI>Messages are produced by status returned from the printer,
when the <CODE>-Tstatus=on</CODE> (default) option is enabled.
These are classified according to the Hewlett-Packard Printer Job Language
error status definitions,
and logged to the STDERR output of the filter.</LI>
<LI>In addition to error messages,
ongoing status messages are also produced.
If the printcap entry has a <CODE>ps=</CODE><EM>statusfile</EM> entry and the
<EM>statusfile</EM> exists and is writeable,
then the error and status messages will be written to the log file.</LI>
<LI>If the message concerns a serious matter or has been returned from the
printer as an 'ALERT' in it,
then the message can also be sent to a 'summaryfile'.
This file can be either a file
OR a UDP socket on a host. This is specified with the
<CODE>-Tsummary=</CODE><EM>summaryfile</EM> option. For example,
<PRE>
        ifhp -Tsummary=taco%3000
</PRE>
 would send messages to UDP port 3000
on host taco.</LI>
<LI>If you do not want the filter to report status on its STDERR output,
use the <CODE>-Tquiet</CODE> option to suppress this, or
compile it with the -DQUIET option.</LI>
</OL>

<A NAME="ifhpaccounting"></A> <H3>Accounting Information</H3>

<P>Doing printer accounting  is not simple.
Read
<A HREF="LPRng-HOWTO-10.html#accountingref">LPRng Accounting</A>
for more information.
<P>In order to help aid in accounting,
by default the <CODE>ifhp</CODE> filter will query the printer
to get the current value of the <B>hardware</B> page counter value,
if there is such a thing on the printer.
Unfortunately,
due to different types of printers and errors in their PJL, PCL,
and PostScript implementations,
several different methods need to be used.
<OL>
<LI>Only a printer with a bidirectional port will return status,
so you need to have a bidirectional connection.</LI>
<LI>If the printer is still printing a job,
then getting the value of the hardware page counter will be useless;
you need to wait until the printer is idle,
i.e. - synchronize your operations with the printer.
<P>Unfortunately,
some printers return an <CODE>idle</CODE> indication even when
they are printing pages of the previous job.
This means that the printer has to be polled,
and only when it is idle <B>and</B> the pagecounter value has been
stable for a reasonable time (5 seconds?)
can you trust the page counter value.
This slows down job printing very seriously.
<P>Some of the newer PJL printers have a
<CODE>PJL TEOJ</CODE>,
or return end of job indication when the last page of a job
has been printed.
If you have this capability,
you can speed up printing.
</LI>
<LI>If your printer supports Hewlett-Packard Printer Job Language
<CODE>PJL INFO PAGECOUNT</CODE>
facility,
then it will first be tried to get the page count.</LI>
<LI>If your printer does not return pagecount information
using the PJL facility and it has PostScript support (default),
then a small PostScript job will be sent to the printer
requesting the <EM>systemdict pagecounter</EM> value.
Unfortunately,
different implementations and versions of PostScript will
need different programs.
The PostScript Printer Definition file for the printer will
have the correct script that is needed.
The default script that is used is:
<PRE>
 /ps { print flush } def
 (\tPAGECOUNT ) ps
 statusdict begin pagecount end == flush
</PRE>
</LI>
<LI>To confuse matters totally,
some printers
which can do PostScript
interpretation do not support PJL <EM>PAGECOUNT</EM> reporting.
You can use the PostScript method to get the pagecount information,
but you cannot get status.</LI>
<LI>The pagecounter information is obtained at the start and end of processing
a job,
and is printed in the accounting file and also on File Descriptor 3
(if it is open).
This information has the format:
<P>
<PRE>
  start -ppagecounter -Ff -kjob -uuser -hhost -R...
  end  -ppages -qpagecounter -Ff -kjob -uuser -hhost -R...
</PRE>
<P>When we use the OF filter and/or banners,  we will see the
individual jobs bracketed by the OF filter records:
<P>
<PRE>
    start -p100 -Fo -kcfA100taco -uuser -hhost -R...
    start -p101 -Ff -kcfA100taco -uuser -hhost -R...
    end  -p1 -q102 -Ff -kcfA100taco -uuser -hhost -R...
    start -p102 -Ff -kcfA100taco -uuser -hhost -R...
</PRE>
<P>We can use the various job numbers and other information
to track page usage.
</LI>
</OL>
<P>The following are a selected set of printcap entries that can
be used to get page counting information:
<PRE>
# use defaults, try to get pagecount using all methods, wait for stable
# value of pagecount before proceeding
pr:...
  :of=/usr/local/lib/filter/ifhp
# printer support PJL True End of Job and PAGECOUNT
pr:...
  :of=/usr/local/lib/filter/ifhp -Ttrue_eoj=on
# no PJL INFO status available, but you can get page count using postscript
pr:...
  :of=/usr/local/lib/filter/ifhp -Tinfostatus=off,forcepagecount
</PRE>
<P>You should try connecting to your printer directly
and testing the accounting facilities.
You can do this by using the <CODE>ifhp -Tdev=...</CODE>
facility.
For example:
<PRE>
ifhp '-Tdev=/dev/ttyb,stty=38400 -echo -crmod -raw -oddp \
-evenp ixon pass8 -ixany cbreak' -Tdebug=5 &lt;ellipse.ps
ifhp -Tdev=astart14%9100 -Tdebug=5 -Ttrue_eoj &lt;ellipse.ps
</PRE>

<A NAME="psfilter"></A> <H2><A NAME="ss6.12">6.12 psfilter PostScript Printer Filter</A>
</H2>

<P>Source code:
<A HREF="LPRng-HOWTO-1.html#secftp">LPRng Distribution, psfilter-&lt;version>.tgz</A><P>The
<CODE>psfilter</CODE> is similar to the CTI-ifhp
filter in its operation and functionality.
Its general operation and procedures are similar,
but it has the following additions:
<OL>
<LI> It will translate text jobs to PostScript and print them
using PostScript unless the jobs are <EM>literal</EM> or binary formats.</LI>
<LI> It will use the PostScript serial line status query support
to obtain status and other error information.</LI>
<LI> When you are sending a PostScript file with <EM>binary</EM> information,
you need to either suppress status gathering,
or you need to use the
<EM>Transparent Binary Communications Protocol</EM>.
Note that older PostScript printers do not support this.</LI>
</OL>

<A NAME="psfilterprintcap"></A> <H3>IF and OF Filter Support</H3>

<P>During the installation process,
<CODE> psif </CODE> and
<CODE> psof </CODE> symbolic links are made to the
<CODE> psfilter</CODE> executable.
Thus,
the following printcap entries can be used:
<PRE>
# common use:
lp:...
  :of=/usr/local/lib/filters/psof
  :if=/usr/local/lib/filters/psif
# same effect:
lp:...
  :of=/usr/local/lib/filters/psfilter
  :if=/usr/local/lib/filters/psfilter
</PRE>

<A NAME="psfilteroptions"></A> <H3>Options</H3>

<P>The <CODE>-Tkey=value[,key=value]</CODE> convention is used to
pass options to the psfilter.
The following options are supported.
Many of these are identical in intent to CTI-ifhp options.
<CENTER><TABLE BORDER><TR><TD>
<BR>
Option</TD><TD>Purpose</TD></TR><TR><TD>
<CODE>accounting=/pathname_to_executable</CODE></TD><TD>When the -Taccounting is specified, the specifiedprogram is executed with the same options as thefilter.</TD></TR><TR><TD>
<CODE>debug=level</CODE></TD><TD>set debugging level. The default level is 2;higher values produce more verbose output.</TD></TR><TR><TD>
<CODE>dev=/device</CODE></TD><TD>dev=host%portOpen a connection to either the device or to theport on the host and send output to it. Bydefault, output is send to stdout.</TD></TR><TR><TD>
<CODE>endpause=delay</CODE></TD><TD>When used as the OF filter, at the start and end ofthe job psfilter will query the printer for thevalue of the hardware pagecounter. The differencebetween the start and end values is reported as thenumber of pages used for the job. Unfortunately,some printers such as the HP LaserJet 4 and HPLaserJet 5 report the current value of the pagecounter at the time of request, and it is difficultto determine if the last page has been completelyprinted by examining returned PostScript status.Before querying the printer at the end of a job,the psfilter software will wait endpause seconds(default is 5). On a 12 page per minute printer,this appears to be sufficient to allow the lastpage to be completely printed. However, if theprinter jams on the last page, it will still not bereported and the page count will be off by one.</TD></TR><TR><TD>
<CODE>forcepagecount=[off*|on]</CODE></TD><TD>To find the pagecount value, a PostScript programis sent to the printer. This overrides any otherflags and forces the program to be sent. Usuallyused in combination with -Tstatus=off -Tforceps,and -Tnosync flags. See the comments below forprinter specific problems.</TD></TR><TR><TD>
<CODE>forceps=[off*|on]</CODE></TD><TD>Forces a dummy PostScript job to be sent at thestart of operations. This usually tricks autosense-ing printers into going into PostScript mode andresponding to the PostScript conventions. See thecomments below for printer specific problems.</TD></TR><TR><TD>
<CODE>maxresponse=seconds(default30seconds)</CODE></TD><TD>Specifies how long to wait for a status responsebefore giving an error indication.</TD></TR><TR><TD>
<CODE>nosync=[off*|on]</CODE></TD><TD>Suppresses trying to get status from the PostScriptprinter, as would normally be returned by sending a^T. See the comments below for printer specificproblems.</TD></TR><TR><TD>
<CODE>pagecount=[off|on*]</CODE></TD><TD>Get the pagecounter value from the printer and usefor accounting information. Note that some HPprinters (LJ4s) do not appear to have pagecounters.(Default is on).</TD></TR><TR><TD>
<CODE>reverse=[off*|on]</CODE></TD><TD>Reverse page order on output.</TD></TR><TR><TD>
<CODE>status=[off|on*]</CODE></TD><TD>Query the print device for status and page countinformation. If status is off, then psfilter sim-ply formats input into postscript and does not doaccounting.</TD></TR><TR><TD>
<CODE>stty=stty_options</CODE></TD><TD>If the output device is a serial port, set the con-figuration according to the stty options. Theseoptions should be identical to those used bystty(1).</TD></TR><TR><TD>
<CODE>summary=destination</CODE></TD><TD>Write a one line status summary to the destination.The destination can be a file (i.e. - /tmp/status)or a UDP port on a host (host%port). The host namecan be an hostname or an IP address (i.e.-info.sdsu.edu%2000 or 130.191.163.56%1000).</TD></TR><TR><TD>
<CODE>tbcp=[off*|on]</CODE></TD><TD>Use the Adobe Tagged Binary Communications protocolto send the document when invoked as an IF filter.The OF filter cannot handle binary PostScript docu-ments as it will remove various control sequences.The -Ztbcp LPRng option will also enable TBCP oper-ations.</TD></TR><TR><TD>
<CODE>udp_status_port=host%port</CODE></TD><TD>The HP5m and possibly other printers use port 9101(UDP) to request and send status. When sent a UDPpacket on this port, the printer responds by sendingstatus back to the sender. This option forces theuse of this port for sending status. However, pagecounts and other information still use the standardconnection to the printer.</TD></TR><TR><TD>

</TD></TR></TABLE></CENTER>

<A NAME="psfilteraccounting"></A> <H3>Accounting</H3>

<P>The <CODE>psfilter</CODE> uses the same methods for doing accounting as the
<CODE>CTI-ifhp</CODE> filter.
See
<A HREF="#ifhpaccounting">IFHP Accounting</A> for details.
<P>Consult your printer's PostScript Printer Description file
to determine the PostScript script needed to do accounting.
You may need to modify the default one supplied in the <CODE>psfilter</CODE>
code.
<P>Always test that the printer returns the right accounting information using
a test similar to the following:
<PRE>
psfilter -Tdebug=8 '-Tdev=/dev/ttyb,stty=38400 -echo -crmod -raw -oddp \
-evenp ixon pass8 -ixany cbreak' &lt;ellipse.ps
psfilter -Tdebug=8 -Tdev=astart14%9100 -Ttrue_eoj &lt;ellipse.ps
</PRE>

<A NAME="lppipe"></A> <H2><A NAME="ss6.13">6.13 lp_pipe Filters</A>
</H2>

<P>Source code:
<A HREF="LPRng-HOWTO-1.html#secftp">LPRng Distribution, part of FILTERS_LPRng-&lt;version>.tgz</A><P>The <CODE>lp_pipe</CODE> family of filters was developed to act
as a <EM>network pipe</EM> to network devices.
They are largely replaced by the <CODE>lp=host%port</CODE>, facility.
<UL>
<LI><CODE>tcp-pipe</CODE>: uses a tcp socket (<B>OBSOLETED</B> by
<CODE>lp=host%port</CODE>), but good starting point if you have special
device requirements;</LI>
<LI><CODE>annex-pipe</CODE>: supports annex terminal server.</LI>
</UL>

<A NAME="apsfilter"></A> <H2><A NAME="ss6.14">6.14 apsfilter Filter</A>
</H2>

<P>Source code:
<A HREF="LPRng-HOWTO-1.html#secftp">LPRng Distribution, apsfilter-&lt;version>.tgz</A><P>The <CODE>apsfilter</CODE>
is basically a simple front end to the <CODE>a2ps</CODE> program
(See:
<A HREF="http://wwwinf.enst.fr/~demaille/a2ps/">http://www-inf.enst.fr/~demaille/a2ps/</A> for details),
and is an example of a <EM>MagicFilter</EM> that has powerful
processing capability.
The <CODE>apsfilter</CODE> program sets up options for the
<CODE>a2ps</CODE> program and then invokes it.
<P>The <CODE>a2ps</CODE> program can convert just about any type of file
into PostScript,
and then by using the GhostScript facility can convert this to
the output compatible with a particular printer.
<P>Combined with the LPRng <CODE>qq</CODE> and <CODE>force_queuename</CODE>
options, we can set up virtual queues that do various types of reformatting.
Here is a sample set of printcap entries:
<PRE>
# seen by users - note that the queue name is put into control file,
#  and we then send it to the frontend@host queue for processing
raw:qq:lp=frontend@host
twoup:qq:lp=frontend@host
landscape:qq:lp=frontend@host
frontend:lp=frontend@host:force_queuename=raw
# frontend does the job conversions and accounting
frontend:server
  :lp=/dev/lp:force_queuename=raw
  :if=/usr/local/lib/filter/apsfilter
</PRE>
<H2><A NAME="ss6.15">6.15 Using your own filters</A>
</H2>

<P>If you already have a working setup, with its own specific filter
programs, you might want to keep them. Or, you might want to write a
set of your own.
<P>See the source code in the
<A HREF="LPRng-HOWTO-1.html#secftp">LPRng Distribution, FILTERS_LPRng-&lt;version>.tgz</A> files for examples.
<A NAME="sd"></A> 
<A NAME="cd"></A> <HR>
<A HREF="LPRng-HOWTO-7.html">Next</A>
<A HREF="LPRng-HOWTO-5.html">Previous</A>
<A HREF="LPRng-HOWTO.html#toc6">Contents</A>
</BODY>
</HTML>
