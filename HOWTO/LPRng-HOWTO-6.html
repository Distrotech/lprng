<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
 <META NAME="GENERATOR" CONTENT="SGML-Tools 1.0.9">
 <TITLE> LPRng-HOWTO: The Most Frequently Asked Questions</TITLE>
 <LINK HREF="LPRng-HOWTO-7.html" REL=next>
 <LINK HREF="LPRng-HOWTO-5.html" REL=previous>
 <LINK HREF="LPRng-HOWTO.html#toc6" REL=contents>
</HEAD>
<BODY>
<A HREF="LPRng-HOWTO-7.html">Next</A>
<A HREF="LPRng-HOWTO-5.html">Previous</A>
<A HREF="LPRng-HOWTO.html#toc6">Contents</A>
<HR>
<H2><A NAME="FAQ"></A> <A NAME="s6">6. The Most Frequently Asked Questions</A></H2>

<P>In this section, the Most Frequently Asked Questions
have been placed, together with their answers.
You may notice that some questions have the same answer,
but the symptoms appear differently.
<P>Some of these answers will reference other material in this FAQ,
or the LPRng man pages.
<H2><A NAME="ss6.1">6.1 Why do I get malformed from address errors?</A>
</H2>

<P>This is the number one question asked by most LPRng users
who try to use LPRng with network printers or other systems
supporting
<A HREF="#rfc1179">RFC1179</A> printing.
For details about LPRng and RFC1179, see
<A HREF="LPRng-HOWTO-18.html#rfc1179ref">RFC1179 and LPRng</A>.
<P>The
<CODE> malformed from address </CODE> error is usually reported when
trying to send a print job from LPRng to other BSD LPR or RFC1179
LPR implementations, or with network connected printers
that have a built in LPR server.
This is due to the following RFC1179 rule:
<BLOCKQUOTE>
Servers originate a connection from ports in the range 721-731.
</BLOCKQUOTE>
<P>WHY?  These are a subset of the 'reserved' ports in UNIX, and normal users
cannot open connections from them.  This provides a small amount
of security from UNIX users on the host 'spoofing' a server.
<P>IMPLICATION:  in order to do use a reserved port,  the program
must have root privileges.  This means the LPR, LPD, LPQ, etc.,
programs must be installed SUID root.  This can open up a can
of worms with regard to security,  but LPRng has been designed to
take as much paranoid care as possible to avoid problems.
<P>WHAT TO DO:<BR>
When installing LPRng,  you will need to install the executables
SUID root.
In the <CODE>src/Makefile</CODE>,  you can remove the comment from the line
<BLOCKQUOTE><CODE>
<PRE>
PERMS=SUID_ROOT_PERMS
</PRE>
</CODE></BLOCKQUOTE>

and then do <CODE> make install</CODE>.
This will install the executables
SUID, and owned by root.
<H2><A NAME="ss6.2">6.2 It was working normally, then I get connection refused errors</A>
</H2>

<P>This message usually appears when you have been sending a large number
of jobs to a network printer or a remote system.
The reason for this is a combination the above port 721-731 restriction
and the TCP/IP timeouts.
For details, see
<A HREF="LPRng-HOWTO-18.html#rfc1179ref">RFC1179 and LPRng</A>,
but here is a quick explanation.
<P>A TCP/IP connection is usually specified as between
<CODE>srchost:srcport, desthost:destport</CODE>,
although in practice the order of source (src) and destination
(dest) is not important.
<P>When a connection is established,  each end of the connection
exchanges the necessary flow control and error control information.
When a connection is terminated,
each end of the connection will not accept another connection from
the same <CODE>host:port</CODE> that was previously active
for a specified timeout period,
usually 10 minutes.
<P>Some TCP/IP implementations go further:  they will not allow
<B>ANY</B> connection to be <B>originated</B>
(via the <CODE>bind()</CODE> system call or API)
from a port that was active,
or accepted on a port that was active for this timeout period.
<P>Now let us see what happens when we have a client program,
which must originate a connection on port 721-731, connect
to the server, which waits for a connection on port 515.
We first try to make a connection from host:port
<CODE>1.1.1.1:721</CODE> to
<CODE>1.1.1.2:515</CODE>.
The first time that we make the connection (or the first connection)
we succeed.
We can transfer a file, etc., and then close the connection.
When we try to reconnect from
<CODE>1.1.1.1:721</CODE> to
<CODE>1.1.1.2:515</CODE>
we get an error such as
"address already in use"
or "connection refused".
<P>Luckily,  we can use port 722 to originate a connection,
and we can connect from
<CODE>1.1.1.1:722</CODE> to
<CODE>1.1.1.2:515</CODE>.
We continue on, until we come to port 731,
and then we need to wait for our timeouts.
<P>SOLUTION:
<P>It appears that most RFC1179 implementations do not check for the exact
port
range 721-731,  but only that the connection originates from a
reserved port,
i.e. - in the range 1-1023.
You can extend the range of ports used by LPRng by changing the
<BLOCKQUOTE><CODE>
<PRE>
originate_port=721 731
</PRE>
</CODE></BLOCKQUOTE>

value in the defaults (<CODE>LPRng/src/common/defaults.c</CODE>) file or in the <CODE>lpd.conf</CODE>
file.  I recommend the following:
<BLOCKQUOTE><CODE>
<PRE>
originate_port=512 1022
</PRE>
</CODE></BLOCKQUOTE>

This is, in fact, now the default in LPRng software.
If you get the infamous
<CODE>malformed from address</CODE>
error message from your spooler, then
you will have to set originate_port=721 731,  and live with
a delayed throughput.
<H2><A NAME="ss6.3">6.3 Job is not in print queue, but it gets printed!</A>
</H2>

<P>In the original BSD LPD implementation,
the LPR program copied users files to a special spool queue directory,
and then caused the LPD server to peek in the directory and print
the files.
<P>This type of operation required spool directory space,
special SETUID programs,
and a slew of headaches in system security and management.
<P>The LPR, LPQ, and other user programs in the LPRng suite use TCP/IP
connections and transfer jobs directly to a LPD server running on
a remote host,
or even the local host if appropriate.
Note that this type of operation does not require a LPD server to run
on each local machine.
In fact,  you can have a single host system performing all of your
printing.
This type of operation is very similar to a central mail server versus
individual systems, each having their own mail server and queues.
<P>However,
some users require or want their jobs to be spooled on the local host system,
and then transferred to the remote printer.
This is usually the case when some type of processing (filtering)
is needed in order to print the job correctly.
There are several methods that can be used to force this.
<P>Method 1: Explicit Printer Address
<P>You can force a job to be sent directly to the <CODE> pr </CODE>
serviced by the LPD server on
<CODE>host</CODE>
by using the form:
<BLOCKQUOTE><CODE>
<PRE>
lpr -Ppr@host file
</PRE>
</CODE></BLOCKQUOTE>
<P>You can also set the <CODE>PRINTER</CODE> environment variable to
a similar form, and get the same effect:
<BLOCKQUOTE><CODE>
<PRE>
PRINTER=pr@host; export PRINTER;
lpr file
</PRE>
</CODE></BLOCKQUOTE>
<P>Method 2: User and Server Printcap Entries
<P>If you want to have the benefits of a printcap file,
i.e. - you can use aliases or abbreviations for the names of printers,
then here is a couple of hints.
First,
the LPRng software scans the <CODE>/etc/printcap</CODE> file for printcap
entries, combining information for the same printer into a single entry.
Information found later in the printcap file will override earlier
information.
In addition,
you can tag entries as either being used for all utilities or just
for the LPD server.
Here are a couple of examples:
<BLOCKQUOTE><CODE>
<PRE>
# for all utilities
pr:lp=pr@host
# just for LPD
pr:server
  :lp=/dev/lp
# more information
pr:check_for_nonprintable@
# --- final result for LPR
pr:lp=pr@host:check_for_nonprintable@
# --- final result for LPD
pr:lp=/dev/lp:check_for_nonprintable@
</PRE>
</CODE></BLOCKQUOTE>
<P>As you can see,
the <CODE>server</CODE>
keyword indicates that the printcap entry is only for the printer.
The LPR utility will send the job to the host, while the LPD server
will print it on <CODE>/dev/lp</CODE>.
<P>Note that the <CODE>lp=...</CODE> information overrides the
<CODE>:rp:</CODE> (remote printer)
and
<CODE>:rm:</CODE> (remote machine) fields if they are present.
<P>Method 3: Force sending to server on <CODE>localhost</CODE>
<P>The
<CODE>force_localhost</CODE>
printcap or configuration flag forces non-LPD applications to send all
requests and print jobs to the server running on the local host.
<P>This method is similar to the previous one,
but has the benefit that it can be configured as a global (i.e. -
applies to all printers) rather than printer specific.
You can put this in the <CODE>/etc/lpd.conf</CODE> file for general
application,  or have a printcap entry of the following form:
<BLOCKQUOTE><CODE>
<PRE>
# for all utilities
pr:lp=pr@host:force_localhost
</PRE>
</CODE></BLOCKQUOTE>
<P>The LPD server will ignore the
<CODE>force_localhost</CODE> flag,
and send jobs to the <CODE>pr</CODE> queue on the <CODE>host</CODE>
machine.
However, the LPR, LPQ, etc., utilities will send their requests to the
server running on the local host.
<H2><A NAME="ss6.4">6.4 Job disappears and is never printed, but lpr works</A>
</H2>

<P>This is a rather disconcerting problem,
and usually occurs when sending jobs to either a network printer or
a nonconforming
<A HREF="#rfc1179">RFC1179</A>
print spooler.
For details about LPRng and RFC1179, see
<A HREF="LPRng-HOWTO-18.html#rfc1179ref">RFC1179 and LPRng</A>,
but here is a quick explanation.
<P>An LPD job consists of a control file,  which contains information
about the job,  and one or more data files.  RFC1179 is silent on the
order that jobs are sent;  however some implementations REQUIRE that
the data files be sent first,  followed by the control file.
<P>SOLUTION:
<P>Set the <CODE>send_data_first</CODE> flag in the printcap for the particular
printer,  or in the <CODE>lpd.conf</CODE> configuration file.  This is:
<BLOCKQUOTE><CODE>
<PRE>
:send_data_first:  (printcap)
send_data_first    (lpd.conf)
</PRE>
</CODE></BLOCKQUOTE>
<P>Note that some printers/servers INSIST on the control file first;
You can clear the flag using <CODE>send_job_first@</CODE> if you need to.
<H2><A NAME="ss6.5">6.5 I get messages about bad control file format</A>
</H2>

<P>RFC1179 describes a set of fields that MAY appear in the control file.
It is silent if other ones can appear as well.
Unfortunately,  some implementations will reject jobs unless they contain
ONLY fields from a very small set.  In addition,  RFC1179 is silent
about the ORDER the fields can appear.
<P>LPRng quite happily will accept jobs from poor or nonconforming RFC1179
spooler programs,
and fix them up to be conformant.
<P>If you are sending jobs to one of a non-conforming spooler,
you can force LPRng to send jobs with only the fields described
in RFC1179 by setting the
the <CODE> :bk: </CODE> (BacKwards compatible) flag in the
printcap for your printer.
<H2><A NAME="rfc1179"></A> <A NAME="ss6.6">6.6 What is RFC 1179, the Line Printer Daemon Protocol?</A>
</H2>

<P>RFC1179 defines a standard method by which print jobs can be transferred
using the TCP/IP protocol between hosts.
The standard was developed by simply detailing the way that
a version of the BSD LPD software did its job.
<P>From the RFC Introduction:
<BLOCKQUOTE>
RFC 1179 describes a print server protocol widely used on
the Internet for communicating between line printer daemons (both
clients and servers).  RFC1179 is for informational purposes only,
and does not specify an Internet standard.
</BLOCKQUOTE>
<P>Having said this,
the RFC then goes on to describe the protocol used
by a particular implementation of LPD.
The problem was that the RFC did not provide
any way to put extensions to the operations into the system,
and failed to specify such interesting details as the order in which
print jobs and their components could be transferred.
<P>Comment by Patrick Powell <CODE> &lt;papowell@astart.com> </CODE>:
<BLOCKQUOTE>
<P>Since 1988,
there have been a large number of print spooling systems developed which
claim RFC1179 conformance,
but which are mutually incompatible.
<P>Rather than live with the limited capabilities of the RFC1179 standard,
LPRng has extended them by adding capabilities to perform remote control
of print spoolers,
encrypted and authenticated data transfers,
and other operations missing from the RFC1179 specification.
However,
great effort was made to be backwards compatible with older and other LPD
based systems.
<P>LPRng was developed in order to be able to both accept and provide
interactions with these systems.  It does so by allowing various options
to be used to <EM>tune</EM> how print jobs would be exchanged.
Currently,
LPRng can be configured to send and receive print jobs between a vast number
of the existing spooling systems.
It is flexible enough to act as a gateway between non-compatible systems,
and has provisions to transform jobs from one format to another in a dynamic
manner.
</BLOCKQUOTE>
<P>For a detailed explanation
about LPRng and RFC1179, see
<A HREF="LPRng-HOWTO-18.html#rfc1179ref">RFC1179 and LPRng</A>.
<H2><A NAME="ss6.7">6.7 I want to replace lp, lpstat, etc, but my programs need them</A>
</H2>

<P>LPRng was designed as a replacement the BSD printing system. As such,
it inherited its command names and options from the latter. As you
might know, System&nbsp;V uses a totally different set of commands,
incompatible with the BSD ones.
<P>The good news is that the LPRng binaries include an emulation for the
System&nbsp;V commands.
(See
<A HREF="LPRng-HOWTO-4.html#lpsimulation">lp Simulation</A>
for details.
Briefly, you create links to the appropriate programs,
and invoke them by the link names.
<EM>Actually, these links are installed by default in recent versions.</EM>
<P>
<BLOCKQUOTE><CODE>
<PRE>
ln -s lpr lp
ln -s lpq lpstat
ln -s lprm cancel
</PRE>
</CODE></BLOCKQUOTE>
<P>If you make these links, calling <CODE>lp</CODE>, <CODE>lpstat</CODE> and
<CODE>cancel</CODE> will give you a (partial) SVR4 emulation. They have
their own man pages, which you should read if you need the emulation.
<P>Since it is a <B>partial</B> emulation, you shouldn't expect everything
to work. In particular, I would guess that any script which relies on
the output format of one of your system binaries will break.
Again, see
<A HREF="LPRng-HOWTO-4.html#lpsimulation">lp Simulation</A>
for more details or additional suggestions.
<H2><A NAME="ss6.8">6.8 What are the drawbacks to LPRng?</A>
</H2>

<P>There are many reasons to run LPRng, and most of them are related to
the extra features it has, compared to vanilla BSD LPR. A short list
is given in section
<A HREF="LPRng-HOWTO-1.html#secfeatures">What is LPRng?</A>. (A
more elaborate description can be found in the LPRng package itself.)
<P>On the other hand, there are also reasons <B>not</B> to switch to LPRng:
<UL>
<LI>Switching from a System&nbsp;V system will require some work.
On the other hand,
getting System&nbsp;V printing to work correctly for you may be even more work.</LI>
<LI>You don't need any of the enhanced features,
and are not worried about security issues.
On the other hand,
you may not have known about them.</LI>
<LI>While there are many resources and books devoted to the old BSD
printer daemon, documentation for LPRng is rather limited.
On the other hand, you get lots of diagnostics and error messages when things
go wrong.</LI>
</UL>
<HR>
<A HREF="LPRng-HOWTO-7.html">Next</A>
<A HREF="LPRng-HOWTO-5.html">Previous</A>
<A HREF="LPRng-HOWTO.html#toc6">Contents</A>
</BODY>
</HTML>
