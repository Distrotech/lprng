<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
 <META NAME="GENERATOR" CONTENT="SGML-Tools 1.0.9">
 <TITLE> LPRng-HOWTO: Defective RFC1179 Implementations</TITLE>
 <LINK HREF="LPRng-HOWTO-20.html" REL=next>
 <LINK HREF="LPRng-HOWTO-18.html" REL=previous>
 <LINK HREF="LPRng-HOWTO.html#toc19" REL=contents>
</HEAD>
<BODY>
<A HREF="LPRng-HOWTO-20.html">Next</A>
<A HREF="LPRng-HOWTO-18.html">Previous</A>
<A HREF="LPRng-HOWTO.html#toc19">Contents</A>
<HR>
<H2><A NAME="s19">19. Defective RFC1179 Implementations</A></H2>

<P>Most printer (or print server box) manufacturers totally ignore the
details of the RFC1179 protocol and simply accept the data files for printing,
disregarding the control file <B>until they need to print a banner
or provide status information</B>.
<P>At this point,
you suddenly discover all sorts of little details
that cause horrible problems.
For example,
the use of non-ASCII characters (i.e. - values are 128-255) in the
J (job) line of a control file has been known to crash one network
interface card in such a manner that a power-up is needed to restart
the printer.
<P>Also,
if you send one particular RFC1179 compatible print spooler a
control file with a character whose value is 255 (i.e. 0xFF),
the job will never get printed,
and there is a mysterious diagnostic on the console:
<BLOCKQUOTE><CODE>
<PRE>
unexpected end of input
</PRE>
</CODE></BLOCKQUOTE>
<P>This is due to the fact that the 0xFF eight bit value is getting sign
extended to a 16 bit value 0xFFFF,
which just turns out to be -1, or the error indication from a read.
<H2><A NAME="ss19.1">19.1 OS2 Print Spoolers</A>
</H2>

<P>For various reasons,  some versions of the OS/2 <CODE>lpd</CODE>
print spooler have decided to make the control file and data file names
have different formats.
<P>In addition,
the OS/2 spooler does not follow RFC1179 correctly,  and truncates
the data and job file protocol exchange.
<H2><A NAME="ss19.2">19.2 Serious Security Loophole</A>
</H2>

<P>There is the subtle and nasty problem with some print filters
that are not
<EM>meta-char-escape</EM> proof.
For example,
suppose that a user decided to spool a job as follows:
<BLOCKQUOTE><CODE>
<PRE>
lpr '-J; rm -rf /*;' /tmp/a
</PRE>
</CODE></BLOCKQUOTE>
<P>This would create a job file with the line:
<BLOCKQUOTE><CODE>
<PRE>
J `rm /etc/passwd; echo Job;`
</PRE>
</CODE></BLOCKQUOTE>
<P>The job line ends up getting passed to a print filter:
<BLOCKQUOTE><CODE>
<PRE>
pr:sd=/...
  :if=/usr/local/hack
    ... invoked as:
    /usr/local/hack '-J; rm -rf /*;'

/usr/local/hack is:

#!/bin/sh
while [ -n "$1" ] ; do
        case "$1" in
        -J  )  shift; args="$args -M$1";;
        esac;
        shift;
done;
# reformat the command line
eval /usr/local/realfilter $args

^^^^
</PRE>
</CODE></BLOCKQUOTE>
<P>The observant reader will notice that the above line gets expanded to:
<BLOCKQUOTE><CODE>
<PRE>
eval /usr/local/realfilter -MJ; rm -rf /*;
</PRE>
</CODE></BLOCKQUOTE>
<P>
<HR>
<A HREF="LPRng-HOWTO-20.html">Next</A>
<A HREF="LPRng-HOWTO-18.html">Previous</A>
<A HREF="LPRng-HOWTO.html#toc19">Contents</A>
</BODY>
</HTML>
