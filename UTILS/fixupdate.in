#!@PERL@
use strict;
for (@ARGV){
	my($hfile,$cfile,$s,$t,$h);
	#print "arg '$_'\n";
	$hfile = $_;
	($cfile = $hfile) =~ s/.*\///;
	$cfile = "common/" . $cfile;
	$cfile =~ s/\.h$/.c/;
	#print "cfile '$cfile', hfile '$hfile'\n";
	if( !open( CFILE, "<$cfile") ){
		warn "cannot open '$cfile'";
		next;
	}
	while (<CFILE>) {
		chop;	# strip record separator
		if (/^[A-Za-z]/ .. /^{/) {
			chomp;
			if( /{/ ){
				$s .= ";\n";
				$t .= $s;
				$s = "";
			} elsif( $s ){
				$s .= "\n" . $_;
			} else {
				$s = $_;
			}
		}
	}
	close CFILE ;
	$t .= "\n#endif\n" if $t;
	#print $t;
	open( HFILE, "<$hfile") or die "cannot open '$hfile'";
	while( <HFILE> ){
		$h .= $_;
		if( /PROTOTYPE/ ) {
			$h .= $t;
			last;
		}
	}
	# print $h;
	`cp $hfile $hfile.bak`;
	open( HFILE,">$hfile") or die "cannot open '$hfile'";
	print HFILE $h;
	close HFILE;
}
